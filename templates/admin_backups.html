{# templates/admin_backups.html #}
{% extends "layout.html" %}

{% block title %}Meus Backups Salvos ‚Äì G-Packer{% endblock %}

{% block extra_head %}
<style>
    .page-single-col {
        display: block;
        margin: 0 auto;
    }

    .table-responsive {
        border-radius: 12px;
    }

    .backup-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 10px;
    }

    .backup-table th {
        text-align: left;
        padding: 16px;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #94a3b8;
        background-color: rgba(15, 23, 42, 0.6);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .backup-table td {
        padding: 16px;
        vertical-align: middle;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        color: #e2e8f0;
        font-size: 0.9rem;
    }

    .backup-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .backup-table tbody tr:hover {
        background-color: rgba(99, 102, 241, 0.08);
    }

    .backup-table tbody tr:last-child td {
        border-bottom: none;
    }

    .file-name {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        color: #f1f5f9;
    }

    .file-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
        border-radius: 8px;
        font-size: 1.2rem;
    }

    .badge-size {
        background: rgba(16, 185, 129, 0.15);
        color: #34d399;
        padding: 4px 10px;
        border-radius: 99px;
        font-size: 0.8em;
        font-weight: 600;
        border: 1px solid rgba(16, 185, 129, 0.2);
        white-space: nowrap;
    }

    .badge-count {
        background: rgba(59, 130, 246, 0.18);
        color: #93c5fd;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid rgba(59, 130, 246, 0.35);
        white-space: nowrap;
    }

    .text-muted {
        color: #94a3b8;
        font-size: 0.85em;
    }

    .actions-cell {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #64748b;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
        display: block;
    }

    .btn-back-custom {
        color: #94a3b8;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 99px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .btn-back-custom:hover {
        color: #f8fafc;
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .explorer-tree {
        max-height: 420px;
        overflow-y: auto;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 6px 0;
        font-size: 0.85rem;
    }

    .explorer-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 12px;
        gap: 8px;
    }

    .explorer-row:hover {
        background: rgba(148, 163, 184, 0.12);
    }

    .explorer-main {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .explorer-indent {
        display: inline-block;
        width: 0;
        height: 1px;
    }

    .explorer-icon {
        width: 18px;
    }

    .explorer-name {
        word-break: break-all;
    }

    .explorer-size {
        font-size: 0.75rem;
        color: #9ca3af;
        font-variant-numeric: tabular-nums;
    }

    .modal-backdrop.hidden {
        display: none;
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }

    .modal.lg {
        width: 90%;
        max-width: 1100px;
        max-height: 90vh;
        background: rgba(15, 23, 42, 1);
        border-radius: 16px;
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
    }

    .modal-header,
    .modal-footer {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-footer {
        border-bottom: none;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
    }

    .modal-body {
        padding: 12px 16px 16px;
        overflow: hidden;
    }

    .explorer-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .lock-icon {
        font-size: 0.8rem;
        margin-left: 4px;
        opacity: 0.8;
    }

    /* Dropdown de vers√µes (linha do tempo de snapshots) */
    .version-dropdown {
        position: relative;
        display: inline-block;
    }

    .version-dropdown-toggle {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }

    .version-dropdown-menu {
        position: absolute;
        top: 110%;
        left: 0;
        background: #020617;
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 10px;
        padding: 8px;
        min-width: 260px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.75);
        z-index: 40;
        display: none;
    }

    .version-dropdown-menu.show {
        display: block;
    }

    .version-dropdown-item {
        padding: 6px 6px 8px 6px;
        border-radius: 8px;
        transition: background 0.15s ease;
    }

    .version-dropdown-item:hover {
        background: rgba(15, 23, 42, 0.9);
    }

    .version-dropdown-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 4px;
        margin-bottom: 4px;
        font-size: 0.78rem;
    }

    .version-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.18);
        border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .version-type {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .version-type-full {
        background: rgba(34, 197, 94, 0.18);
        border: 1px solid rgba(34, 197, 94, 0.6);
        color: #bbf7d0;
    }

    .version-type-inc {
        background: rgba(59, 130, 246, 0.18);
        border: 1px solid rgba(59, 130, 246, 0.6);
        color: #bfdbfe;
    }

    .version-date {
        margin-left: auto;
        font-size: 0.7rem;
        color: #9ca3af;
        white-space: nowrap;
    }

    .version-dropdown-actions {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .btn-xxs {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 999px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page page-single-col">
    <header class="page-header">
        <div class="page-header-top">
            <div>
                <h1>üì¶ Meus Backups Salvos</h1>
                <p class="subtitle">Gerencie os arquivos compactados gerados pelo servidor.</p>
            </div>
        </div>
    </header>

    <div class="card main-card" style="min-height: auto;">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="page-flash" style="margin-bottom: 24px;">
            <div class="alert"
                style="background: rgba(234, 179, 8, 0.15); border-color: rgba(234, 179, 8, 0.3); color: #fde047;">
                {% for msg in messages %}
                <div>{{ msg }}</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endwith %}

        <div class="table-responsive">
            <table class="backup-table">
                <thead>
                    <tr>
                        <th>Nome do Arquivo</th>
                        <th>S√©rie / Vers√£o</th>
                        <th>Arquivos (√∫ltima vers√£o)</th>
                        <th>Tamanho</th>
                        <th>Criado em</th>
                        <th style="text-align:center">A√ß√µes</th>
                    </tr>
                </thead>

                <tbody>
                    {% for series in series_list %}
                    {% set latest = series.latest %}
                    <tr>
                        <td>
                            <div class="file-name">
                                <div class="file-icon">
                                    {% if latest.name.lower().endswith('.zip') %}
                                    ‚¨õ
                                    {% else %}
                                    üì¶
                                    {% endif %}
                                </div>
                                <div>
                                    <div>
                                        {{ latest.name }}
                                        {% if latest.encrypted %}
                                        <span class="lock-icon">üîí</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-muted">
                                        S√©rie: {{ series.series_key }} ¬∑ √öltima vers√£o: v{{ latest.version_index }}
                                    </div>
                                    <div class="text-muted">
                                        Origem: {{ latest.origin_task_id or 'Manual / desconhecida' }}
                                    </div>
                                </div>
                            </div>
                        </td>

                        <!-- COLUNA: dropdown de vers√µes -->
                        <td>
                            <div class="version-dropdown">
                                <button type="button" class="btn-secondary btn-xs version-dropdown-toggle">
                                    üìú Vers√µes ({{ series.versions|length }})
                                </button>
                                <div class="version-dropdown-menu">
                                    {% for v in series.versions %}
                                    <div class="version-dropdown-item">
                                        <div class="version-dropdown-header">
                                            <span class="version-badge">v{{ v.version_index }}</span>
                                            {% if v.is_full %}
                                            <span class="version-type version-type-full">FULL</span>
                                            {% else %}
                                            <span class="version-type version-type-inc">INC</span>
                                            {% endif %}
                                            <span class="version-date">{{ v.created_at }}</span>
                                        </div>
                                        <div class="version-dropdown-actions">
                                            <!-- EXPLORAR = usar o explorer da vers√£o espec√≠fica -->
                                            <button type="button" class="btn-ghost btn-xxs"
                                                onclick="openBackupExplorer({{ v.id }}, '{{ v.name }}')">
                                                üîé Explorar
                                            </button>
                                            <!-- BAIXAR ZIP DAQUELA VERS√ÉO -->
                                            <a href="{{ url_for('admin.download_backup_file', backup_id=v.id) }}"
                                                class="btn-secondary btn-xxs">
                                                ‚¨áÔ∏è Baixar ZIP
                                            </a>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </td>

                        <!-- Arquivos / info da √öLTIMA vers√£o -->
                        <td>
                            <span class="badge-count">
                                {{ latest.items_count }} arquivo(s)
                            </span>
                        </td>
                        <td>
                            <span class="badge-size">
                                {{ '%.2f'|format(latest.size_mb) }} MB
                            </span>
                        </td>
                        <td>
                            <span class="text-muted">
                                {{ latest.created_at }}
                            </span>
                        </td>

                        <!-- A√ß√µes r√°pidas: sempre sobre a √öLTIMA vers√£o -->
                        <td class="actions-cel align-items-center">
                            <button type="button" class="btn-ghost btn-xs"
                                onclick="openBackupExplorer({{ latest.id }}, '{{ latest.name }}')">
                                üîé Explorar √∫ltima vers√£o
                            </button>

                            <a href="{{ url_for('admin.download_backup_file', backup_id=latest.id) }}"
                                class="btn-secondary btn-xs">
                                ‚¨áÔ∏è Baixar √∫ltima vers√£o
                            </a>

                            <a href="{{ url_for('admin.delete_backup', backup_id=latest.id) }}"
                                class="btn-danger btn-xs"
                                onclick="return confirm('Tem certeza que deseja excluir este backup?\\nIsso N√ÉO remove as outras vers√µes desta s√©rie.');">
                                üóë Excluir √∫ltima vers√£o
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <span class="empty-icon">üì≠</span>
                                <h3 style="margin:0 0 8px 0; color:#e2e8f0;">Nenhum backup encontrado</h3>
                                <p style="margin:0; font-size:0.9rem;">
                                    Os arquivos gerados no modo "Segundo Plano" aparecer√£o aqui.<br>
                                    V√° at√© a sele√ß√£o de pastas para criar um novo backup.
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>

{# MODAL EXPLORADOR #}
<div id="backup-explorer-backdrop" class="modal-backdrop hidden">
    <div class="modal lg">
        <div class="modal-header">
            <h3 id="backup-explorer-title">Explorar backup</h3>
            <button type="button" class="btn-ghost btn-xs" onclick="closeBackupExplorer()">‚úï</button>
        </div>

        <div class="modal-body">
            <div class="explorer-toolbar">
                <span id="backup-explorer-subtitle">Carregando estrutura...</span>
                <div style="display:flex; gap:6px;">
                    <button class="btn-ghost btn-xs" type="button" onclick="selectAllInExplorer(true)">
                        Selecionar tudo
                    </button>
                    <button class="btn-ghost btn-xs" type="button" onclick="selectAllInExplorer(false)">
                        Limpar
                    </button>
                </div>
            </div>

            <div id="backup-explorer-tree" class="explorer-tree">
                <!-- √°rvore √© montada via JS -->
            </div>
        </div>

        <div class="modal-footer">
            <span id="backup-explorer-counter" style="font-size:0.8rem; color:#9ca3af;">
                Nenhum arquivo selecionado.
            </span>

            <div style="display:flex; gap:8px;">
                <button type="button" class="btn-ghost" onclick="extractToLocalPath()">
                    üìÇ Extrair no PC
                </button>

                <button type="button" class="btn-secondary" onclick="restoreSelectionToDrive()">
                    ‚òÅÔ∏è Restaurar para o Drive
                </button>
                <button type="button" class="btn-primary" onclick="downloadSelection()">
                    ‚¨áÔ∏è Baixar selecionados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ===========================
    // EXPLORADOR DE BACKUPS
    // ===========================
    let currentBackupId = null;
    let currentBackupName = null;
    const selectedPaths = new Set(); // s√≥ arquivos
    const EXPLORER_TREE_ID = "backup-explorer-tree";

    function formatBytes(bytes) {
        if (bytes == null) return "";
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        const value = bytes / Math.pow(k, i);
        return value.toFixed(2) + " " + sizes[i];
    }

    function openBackupExplorer(backupId, backupName) {
        currentBackupId = backupId;
        currentBackupName = backupName;
        selectedPaths.clear();

        const backdrop = document.getElementById("backup-explorer-backdrop");
        const titleEl = document.getElementById("backup-explorer-title");
        const subtitleEl = document.getElementById("backup-explorer-subtitle");
        const treeEl = document.getElementById(EXPLORER_TREE_ID);

        if (!backdrop || !titleEl || !subtitleEl || !treeEl) return;

        titleEl.textContent = "Explorar backup: " + backupName;
        subtitleEl.textContent = "Carregando estrutura...";
        treeEl.innerHTML = "";
        updateExplorerCounter();

        backdrop.classList.remove("hidden");

        fetch(`/admin/api/backups/${backupId}/tree`)
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert(data.error || "Erro ao carregar conte√∫do do backup.");
                    closeBackupExplorer();
                    return;
                }

                const filesCount = data.files_count || 0;
                subtitleEl.textContent = `${filesCount} arquivo(s) dentro deste backup.`;
                renderBackupTree(data.tree || [], treeEl, 0);
            })
            .catch(err => {
                console.error(err);
                alert("Erro de comunica√ß√£o ao carregar conte√∫do.");
                closeBackupExplorer();
            });
    }

    function closeBackupExplorer() {
        const backdrop = document.getElementById("backup-explorer-backdrop");
        if (backdrop) backdrop.classList.add("hidden");
    }

    function renderBackupTree(nodes, container, depth) {
        nodes.forEach(node => {
            const row = document.createElement("div");
            row.className = "explorer-row";
            row.dataset.path = node.path;
            row.dataset.type = node.type;

            const indent = depth * 16; // px

            row.innerHTML = `
                <div class="explorer-main">
                    <span class="explorer-indent" style="margin-left:${indent}px;"></span>
                    <input type="checkbox" class="explorer-checkbox" data-path="${node.path}">
                    <span class="explorer-icon">${node.type === "folder" ? "üìÅ" : "üìÑ"}</span>
                    <span class="explorer-name">${node.name}</span>
                </div>
                <div class="explorer-meta">
                    ${node.type === "file" && node.size != null
                    ? `<span class="explorer-size">${formatBytes(node.size)}</span>`
                    : ""
                }
                </div>
            `;

            container.appendChild(row);

            const checkbox = row.querySelector(".explorer-checkbox");
            checkbox.addEventListener("change", () => {
                onExplorerCheckboxChange(node, checkbox.checked);
            });

            if (node.children && node.children.length > 0) {
                renderBackupTree(node.children, container, depth + 1);
            }
        });
    }

    function onExplorerCheckboxChange(node, checked) {
        if (node.type === "folder") {
            const prefix = node.path + "/";
            const rows = document.querySelectorAll(`#${EXPLORER_TREE_ID} .explorer-row`);
            rows.forEach(row => {
                const rowPath = row.dataset.path;
                const rowType = row.dataset.type;
                const cb = row.querySelector(".explorer-checkbox");
                if (!cb) return;

                if (rowPath === node.path || rowPath.startsWith(prefix)) {
                    cb.checked = checked;

                    // Apenas arquivos entram no set
                    if (rowType === "file") {
                        if (checked) {
                            selectedPaths.add(rowPath);
                        } else {
                            selectedPaths.delete(rowPath);
                        }
                    }
                }
            });
        } else {
            // arquivo simples
            if (checked) {
                selectedPaths.add(node.path);
            } else {
                selectedPaths.delete(node.path);
            }
        }

        updateExplorerCounter();
    }

    function updateExplorerCounter() {
        const counterEl = document.getElementById("backup-explorer-counter");
        if (!counterEl) return;
        const total = selectedPaths.size;
        if (total === 0) {
            counterEl.textContent = "Nenhum arquivo selecionado.";
        } else if (total === 1) {
            counterEl.textContent = "1 arquivo selecionado.";
        } else {
            counterEl.textContent = `${total} arquivos selecionados.`;
        }
    }

    function selectAllInExplorer(checked) {
        const rows = document.querySelectorAll(`#${EXPLORER_TREE_ID} .explorer-row`);
        selectedPaths.clear();

        rows.forEach(row => {
            const cb = row.querySelector(".explorer-checkbox");
            const type = row.dataset.type;
            if (!cb) return;
            cb.checked = checked;

            if (type === "file" && checked) {
                selectedPaths.add(row.dataset.path);
            }
        });

        updateExplorerCounter();
    }

    function getSelectedPathsArray() {
        return Array.from(selectedPaths);
    }

    function restoreSelectionToDrive() {
        const paths = getSelectedPathsArray();
        if (!paths.length) {
            alert("Selecione pelo menos um arquivo para restaurar.");
            return;
        }

        if (!currentBackupId) {
            alert("Backup inv√°lido.");
            return;
        }

        if (!confirm(`Restaurar ${paths.length} arquivo(s) para o Google Drive?`)) {
            return;
        }

        fetch(`/admin/api/backups/${currentBackupId}/restore-drive`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ paths }),
        })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert(data.error || "Erro ao restaurar arquivos para o Drive.");
                    return;
                }
                alert(`Restaura√ß√£o conclu√≠da: ${data.uploaded.length} arquivo(s) enviados para a pasta 'Restaurados' no seu Drive.`);
            })
            .catch(err => {
                console.error(err);
                alert("Erro de comunica√ß√£o com o servidor.");
            });
    }

    function downloadSelection() {
        const paths = getSelectedPathsArray();
        if (!paths.length) {
            alert("Selecione pelo menos um arquivo para baixar.");
            return;
        }

        if (!currentBackupId) {
            alert("Backup inv√°lido.");
            return;
        }

        fetch(`/admin/api/backups/${currentBackupId}/download-partial`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ paths }),
        })
            .then(resp => {
                if (!resp.ok) {
                    // tenta extrair JSON de erro
                    return resp.json()
                        .then(err => { throw new Error(err.error || "Erro ao gerar download parcial."); })
                        .catch(() => { throw new Error("Erro ao gerar download parcial."); });
                }

                const dispo = resp.headers.get("Content-Disposition") || "";
                const match = dispo.match(/filename=\"?([^\";]+)\"?/i);
                const filename = match ? decodeURIComponent(match[1]) : "backup-parcial.zip";

                return resp.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => {
                console.error(err);
                alert(err.message || "Erro ao fazer download parcial.");
            });
    }

    function extractToLocalPath() {
        if (!currentBackupId) {
            alert("Backup inv√°lido.");
            return;
        }

        const paths = getSelectedPathsArray();
        let message = "";

        if (paths.length === 0) {
            message = "Nenhum arquivo selecionado.\nDeseja extrair o BACKUP INTEIRO?";
        } else {
            message = `Deseja extrair ${paths.length} arquivo(s) selecionado(s)?`;
        }

        if (!confirm(message)) return;

        const targetPath = prompt("Digite o caminho da pasta no computador onde deseja salvar os arquivos:\n(Ex: C:/Meus_Backups/Restaurado)");
        if (!targetPath) return;

        const btn = event.target;
        // Feedback visual r√°pido
        btn.textContent = "Iniciando...";
        btn.disabled = true;

        fetch(`/admin/api/backups/${currentBackupId}/extract-local`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                target_path: targetPath,
                paths: paths
            }),
        })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) {
                    alert("Erro ao iniciar: " + (data.error || "Falha desconhecida."));
                    btn.textContent = "üìÇ Extrair no PC";
                    btn.disabled = false;
                } else {
                    // SUCESSO IMEDIATO
                    alert(`‚úÖ Extra√ß√£o iniciada em segundo plano!\n\nOs arquivos est√£o sendo enviados para:\n${targetPath}\n\nVoc√™ pode fechar esta janela e continuar usando o sistema.`);

                    // Opcional: Fechar o modal automaticamente
                    closeBackupExplorer();

                    // Restaura o bot√£o caso reabra o modal depois
                    btn.textContent = "üìÇ Extrair no PC";
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro de comunica√ß√£o com o servidor.");
                btn.textContent = "üìÇ Extrair no PC";
                btn.disabled = false;
            });
    }

    // -------------------------------
    // Dropdown de vers√µes de backup
    // -------------------------------
    document.addEventListener("click", function (ev) {
        const toggle = ev.target.closest(".version-dropdown-toggle");
        const dropdowns = document.querySelectorAll(".version-dropdown-menu");

        if (toggle) {
            const container = toggle.closest(".version-dropdown");
            const menu = container.querySelector(".version-dropdown-menu");
            const isOpen = menu.classList.contains("show");

            // Fecha todos
            dropdowns.forEach(m => m.classList.remove("show"));

            // Abre somente o clicado, se estiver fechado
            if (!isOpen) {
                menu.classList.add("show");
            }
        } else {
            // Clique fora fecha todos
            dropdowns.forEach(m => m.classList.remove("show"));
        }
    });

</script>
{% endblock %}