{% extends "layout.html" %}

{% block title %}Dashboard de Sa√∫de ‚Äì G-Packer{% endblock %}

{% block extra_head %}
<style>
    .health-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 24px;
    }

    .health-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .health-header h1 {
        margin: 0 0 4px 0;
        color: #f9fafb;
    }

    .health-header .subtitle {
        margin: 0;
        color: #94a3b8;
        font-size: 0.95rem;
    }

    /* BADGE GLOBAL */
    .global-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 20px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.95rem;
        border: 1px solid transparent;
    }

    .status-ok {
        background: rgba(74, 222, 128, 0.15);
        color: #4ade80;
        border-color: rgba(74, 222, 128, 0.35);
    }

    .status-warn {
        background: rgba(250, 204, 21, 0.15);
        color: #facc15;
        border-color: rgba(250, 204, 21, 0.35);
    }

    .status-err {
        background: rgba(248, 113, 113, 0.15);
        color: #f87171;
        border-color: rgba(248, 113, 113, 0.4);
    }

    .pulse {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: currentColor;
        box-shadow: 0 0 10px currentColor;
        animation: pulse-anim 2s infinite;
        flex-shrink: 0;
    }

    @keyframes pulse-anim {
        0% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: .5;
            transform: scale(1.2);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* GRID ‚Äì cards lado a lado e centralizados */
    .health-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
    }

    .health-card {
        width: 340px;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 20px 20px 16px;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        overflow: hidden;
        transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    }

    .health-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.85);
        border-color: rgba(148, 163, 184, 0.45);
    }

    .card-ok {
        border-top: 4px solid #4ade80;
    }

    .card-warning {
        border-top: 4px solid #facc15;
    }

    .card-error {
        border-top: 4px solid #f97373;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .card-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #94a3b8;
        font-weight: 700;
    }

    .card-icon {
        font-size: 1.4rem;
        opacity: 0.9;
    }

    .card-status-text {
        font-size: 1.05rem;
        font-weight: 500;
        color: #f1f5f9;
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .card-footer {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        font-size: 0.78rem;
        color: #9ca3af;
        font-family: monospace;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
    }

    .detail-row span:last-child {
        color: #cbd5e1;
    }

    @media (max-width: 900px) {
        .health-header {
            align-items: flex-start;
        }

        .health-card {
            width: 100%;
            max-width: 420px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="health-container">

    <div class="health-header">
        <div>
            <h1>ü©∫ Sa√∫de do Sistema</h1>
            <p class="subtitle">
                Status em tempo quase real das principais depend√™ncias do G-Packer.
            </p>
        </div>

        {% set global = health.status %}
        {% if global == 'ok' %}
        {% set global_cls = 'status-ok' %}
        {% set global_label = 'Sistema Saud√°vel' %}
        {% elif global == 'degraded' %}
        {% set global_cls = 'status-warn' %}
        {% set global_label = 'Aten√ß√£o Necess√°ria' %}
        {% else %}
        {% set global_cls = 'status-err' %}
        {% set global_label = 'Erro Cr√≠tico Detectado' %}
        {% endif %}

        <div class="global-status {{ global_cls }}" id="global-status">
            <div class="pulse"></div>
            <span id="global-status-label">{{ global_label }}</span>
        </div>
    </div>

    <div class="health-grid">

        {# Macro de card: recebe a key do check pra usarmos no JS (#data-check) #}
        {% macro status_card(title, icon, data, key) %}
        {% set s = data.status %}
        {% if s == 'ok' %}
        {% set card_cls = 'card-ok' %}
        {% elif s == 'warning' or s == 'degraded' %}
        {% set card_cls = 'card-warning' %}
        {% else %}
        {% set card_cls = 'card-error' %}
        {% endif %}

        <div class="health-card {{ card_cls }}" data-check="{{ key }}">
            <div>
                <div class="card-header">
                    <span class="card-title">{{ title }}</span>
                    <span class="card-icon" data-role="status-icon">
                        {% if s == 'ok' %}üü¢{% elif s == 'warning' or s == 'degraded' %}üü°{% else %}üî¥{% endif %}
                    </span>
                </div>

                <div class="card-status-text" data-role="message">
                    {{ data.message }}
                </div>
            </div>

            <div class="card-footer" data-role="footer">
                <div class="detail-row">
                    <span>Lat√™ncia:</span>
                    <span data-role="latency">
                        {{ '%.1f'|format(data.duration_ms or 0.0) }} ms
                    </span>
                </div>
                {% if data.details %}
                {% for k, v in data.details.items() %}
                <div class="detail-row">
                    <span>{{ k|replace('_', ' ')|capitalize }}:</span>
                    <span>{{ v }}</span>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endmacro %}

        {{ status_card("Recursos do Servidor", "üñ•Ô∏è", health.checks.system, 'system') }}

        {{ status_card("Conex√£o Externa (Internet)", "üåê", health.checks.internet, 'internet') }}

        {{ status_card("Banco de Dados", "üóÑÔ∏è", health.checks.database, 'database') }}

        {{ status_card("Google Drive / Auth", "‚òÅÔ∏è", health.checks.google_auth, 'google_auth') }}

        {{ status_card("Armazenamento de Backups", "üíæ", health.checks.disk, 'disk') }}

        {{ status_card("Hist√≥rico de Execu√ß√µes", "‚öôÔ∏è", health.checks.tasks, 'tasks') }}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const POLL_INTERVAL_MS = 500;  // 10 segundos

        function statusToCardClass(status) {
            if (status === "ok") return "card-ok";
            if (status === "warning" || status === "degraded") return "card-warning";
            return "card-error";
        }

        function statusToEmoji(status) {
            if (status === "ok") return "üü¢";
            if (status === "warning" || status === "degraded") return "üü°";
            return "üî¥";
        }

        function updateGlobalStatus(globalStatus) {
            const box = document.getElementById("global-status");
            const label = document.getElementById("global-status-label");
            if (!box || !label) return;

            box.classList.remove("status-ok", "status-warn", "status-err");

            let cls, text;
            if (globalStatus === "ok") {
                cls = "status-ok";
                text = "Sistema Saud√°vel";
            } else if (globalStatus === "degraded" || globalStatus === "warning") {
                cls = "status-warn";
                text = "Aten√ß√£o Necess√°ria";
            } else {
                cls = "status-err";
                text = "Erro Cr√≠tico Detectado";
            }

            box.classList.add(cls);
            label.textContent = text;
        }

        function buildFooterHtml(check) {
            const duration = typeof check.duration_ms === "number"
                ? check.duration_ms.toFixed(1)
                : "0.0";

            let html = `
            <div class="detail-row">
                <span>Lat√™ncia:</span>
                <span>${duration} ms</span>
            </div>
        `;

            if (check.details) {
                for (const [key, value] of Object.entries(check.details)) {
                    const label = key
                        .replace(/_/g, " ")
                        .replace(/\b\w/g, c => c.toUpperCase());

                    html += `
                    <div class="detail-row">
                        <span>${label}:</span>
                        <span style="color:#cbd5e1;">${value}</span>
                    </div>
                `;
                }
            }

            return html;
        }

        function applyHealthData(data) {
            if (!data || !data.checks) return;

            // Atualiza badge global
            updateGlobalStatus(data.status);

            const checks = data.checks;

            const keys = ["system", "internet", "database", "google_auth", "disk", "tasks"];

            keys.forEach(key => {
                const check = checks[key];
                if (!check) return;

                const card = document.querySelector(`.health-card[data-check="${key}"]`);
                if (!card) return;

                // Borda do card
                card.classList.remove("card-ok", "card-warning", "card-error");
                card.classList.add(statusToCardClass(check.status));

                // √çcone
                const iconEl = card.querySelector('[data-role="status-icon"]');
                if (iconEl) {
                    iconEl.textContent = statusToEmoji(check.status);
                }

                // Mensagem principal
                const msgEl = card.querySelector('[data-role="message"]');
                if (msgEl && typeof check.message === "string") {
                    msgEl.textContent = check.message;
                }

                // Rodap√© (lat√™ncia + detalhes)
                const footerEl = card.querySelector('[data-role="footer"]');
                if (footerEl) {
                    footerEl.innerHTML = buildFooterHtml(check);
                }
            });
        }

        function fetchHealth() {
            fetch("/health", { cache: "no-store" })
                .then(resp => resp.json())
                .then(applyHealthData)
                .catch(err => {
                    // em caso de erro, logamos no console; UI continua com √∫ltimo valor v√°lido
                    console.error("Erro ao atualizar /health:", err);
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // primeira carga imediata
            fetchHealth();
            // e depois fica atualizando
            setInterval(fetchHealth, POLL_INTERVAL_MS);
        });
    })();
</script>
{% endblock %}
