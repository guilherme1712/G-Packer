{% extends "layout.html" %}

{% block title %}Dashboard de Sa√∫de ‚Äì G-Packer{% endblock %}

{% block extra_head %}
<style>
    .health-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .health-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .health-header h1 {
        margin: 0 0 4px 0;
        color: #f9fafb;
    }

    .health-header .subtitle {
        margin: 0;
        color: #94a3b8;
        font-size: 0.95rem;
    }

    /* BADGE GLOBAL */
    .global-status {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 20px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.95rem;
        border: 1px solid transparent;
    }

    .status-ok {
        background: rgba(74, 222, 128, 0.15);
        color: #4ade80;
        border-color: rgba(74, 222, 128, 0.35);
    }

    .status-warn {
        background: rgba(250, 204, 21, 0.15);
        color: #facc15;
        border-color: rgba(250, 204, 21, 0.35);
    }

    .status-err {
        background: rgba(248, 113, 113, 0.15);
        color: #f87171;
        border-color: rgba(248, 113, 113, 0.4);
    }

    .pulse {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: currentColor;
        box-shadow: 0 0 10px currentColor;
        animation: pulse-anim 2s infinite;
        flex-shrink: 0;
    }

    @keyframes pulse-anim {
        0% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: .5;
            transform: scale(1.2);
        }

        100% {
        opacity: 1;
        transform: scale(1);
        }
    }

    /* GRID ‚Äì cards lado a lado e centralizados */
    .health-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-bottom: 32px;
    }

    .health-card {
        width: 340px;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 20px 20px 16px;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        overflow: hidden;
        transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    }

    .health-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 22px 40px rgba(0, 0, 0, 0.85);
        border-color: rgba(148, 163, 184, 0.45);
    }

    .card-ok {
        border-top: 4px solid #4ade80;
    }

    .card-warning {
        border-top: 4px solid #facc15;
    }

    .card-error {
        border-top: 4px solid #f97373;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .card-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #94a3b8;
        font-weight: 700;
    }

    .card-icon {
        font-size: 1.4rem;
        opacity: 0.9;
    }

    .card-status-text {
        font-size: 1.05rem;
        font-weight: 500;
        color: #f1f5f9;
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .card-footer {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        font-size: 0.78rem;
        color: #9ca3af;
        font-family: monospace;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
    }

    .detail-row span:last-child {
        color: #cbd5e1;
    }

    /* CHARTS SECTION */
    .charts-section {
        margin-top: 24px;
    }

    .charts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .charts-header h2 {
        margin: 0;
        color: #e5e7eb;
        font-size: 1.1rem;
    }

    .charts-header .subtitle {
        margin: 0;
        color: #9ca3af;
        font-size: 0.85rem;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        align-items: flex-start;
    }

    .chart-card {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 14px 16px;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.6);

        /* evita cart√µes gigantes */
        height: 260px;
        display: flex;
        flex-direction: column;
    }

    .chart-card canvas {
        flex: 1;
        max-height: 190px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
    }

    .chart-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #94a3b8;
        font-weight: 600;
    }

    .chart-meta {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    @media (max-width: 900px) {
        .health-header {
            align-items: flex-start;
        }

        .health-card {
            width: 100%;
            max-width: 420px;
        }

        .chart-card {
            height: 240px;
        }

        .chart-card canvas {
            max-height: 170px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="health-container">

    <div class="health-header">
        <div>
            <h1>ü©∫ Sa√∫de do Sistema</h1>
            <p class="subtitle">
                Status em tempo quase real das principais depend√™ncias do G-Packer.
            </p>
        </div>

        {% set global = health.status %}
        {% if global == 'ok' %}
        {% set global_cls = 'status-ok' %}
        {% set global_label = 'Sistema Saud√°vel' %}
        {% elif global == 'degraded' %}
        {% set global_cls = 'status-warn' %}
        {% set global_label = 'Aten√ß√£o Necess√°ria' %}
        {% else %}
        {% set global_cls = 'status-err' %}
        {% set global_label = 'Erro Cr√≠tico Detectado' %}
        {% endif %}

        <div class="global-status {{ global_cls }}" id="global-status">
            <div class="pulse"></div>
            <span id="global-status-label">{{ global_label }}</span>
        </div>
    </div>

    <div class="health-grid">

        {# Macro de card: recebe a key do check pra usarmos no JS (#data-check) #}
        {% macro status_card(title, icon, data, key) %}
        {% set s = data.status %}
        {% if s == 'ok' %}
        {% set card_cls = 'card-ok' %}
        {% elif s == 'warning' or s == 'degraded' %}
        {% set card_cls = 'card-warning' %}
        {% else %}
        {% set card_cls = 'card-error' %}
        {% endif %}

        <div class="health-card {{ card_cls }}" data-check="{{ key }}">
            <div>
                <div class="card-header">
                    <span class="card-title">{{ title }}</span>
                    <span class="card-icon" data-role="status-icon">
                        {% if s == 'ok' %}üü¢{% elif s == 'warning' or s == 'degraded' %}üü°{% else %}üî¥{% endif %}
                    </span>
                </div>

                <div class="card-status-text" data-role="message">
                    {{ data.message }}
                </div>
            </div>

            <div class="card-footer" data-role="footer">
                <div class="detail-row">
                    <span>Lat√™ncia:</span>
                    <span data-role="latency">
                        {{ '%.1f'|format(data.duration_ms or 0.0) }} ms
                    </span>
                </div>
                {% if data.details %}
                {% for k, v in data.details.items() %}
                <div class="detail-row">
                    <span>{{ k|replace('_', ' ')|capitalize }}:</span>
                    <span>{{ v }}</span>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endmacro %}

        {{ status_card("Recursos do Servidor", "üñ•Ô∏è", health.checks.system, 'system') }}

        {{ status_card("Conex√£o Externa (Internet)", "üåê", health.checks.internet, 'internet') }}

        {{ status_card("Banco de Dados", "üóÑÔ∏è", health.checks.database, 'database') }}

        {{ status_card("Google Drive / Auth", "‚òÅÔ∏è", health.checks.google_auth, 'google_auth') }}

        {{ status_card("Armazenamento de Backups", "üíæ", health.checks.disk, 'disk') }}

        {{ status_card("Hist√≥rico de Execu√ß√µes", "‚öôÔ∏è", health.checks.tasks, 'tasks') }}

    </div>

    <!-- Se√ß√£o de gr√°ficos em tempo real -->
    <div class="charts-section">
        <div class="charts-header">
            <h2>üìä Telemetria em Tempo Real</h2>
            <p class="subtitle">
                CPU, mem√≥ria, disco, jobs, falhas, compress√£o e velocidade de download.
            </p>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">CPU x RAM (%)</span>
                    <span class="chart-meta" id="chart-cpu-ram-meta"></span>
                </div>
                <canvas id="chart-cpu-ram"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">Jobs & Falhas</span>
                    <span class="chart-meta" id="chart-jobs-meta"></span>
                </div>
                <canvas id="chart-jobs-failures"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">Compress√£o & Velocidade</span>
                    <span class="chart-meta" id="chart-throughput-meta"></span>
                </div>
                <canvas id="chart-throughput"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    (function () {
        const POLL_INTERVAL_MS = 1000;  // 2 segundos
        const MAX_POINTS = 20;

        // Buffers de m√©tricas para os gr√°ficos
        const series = {
            labels: [],
            cpu: [],
            ram: [],
            diskFree: [],
            runningJobs: [],
            pendingJobs: [],
            failed24h: [],
            avgSpeed: [],
            lastSpeed: [],
            lastCompression: [],
        };

        let cpuRamChart = null;
        let jobsChart = null;
        let throughputChart = null;

        function statusToCardClass(status) {
            if (status === "ok") return "card-ok";
            if (status === "warning" || status === "degraded") return "card-warning";
            return "card-error";
        }

        function statusToEmoji(status) {
            if (status === "ok") return "üü¢";
            if (status === "warning" || status === "degraded") return "üü°";
            return "üî¥";
        }

        function updateGlobalStatus(globalStatus) {
            const box = document.getElementById("global-status");
            const label = document.getElementById("global-status-label");
            if (!box || !label) return;

            box.classList.remove("status-ok", "status-warn", "status-err");

            let cls, text;
            if (globalStatus === "ok") {
                cls = "status-ok";
                text = "Sistema Saud√°vel";
            } else if (globalStatus === "degraded" || globalStatus === "warning") {
                cls = "status-warn";
                text = "Aten√ß√£o Necess√°ria";
            } else {
                cls = "status-err";
                text = "Erro Cr√≠tico Detectado";
            }

            box.classList.add(cls);
            label.textContent = text;
        }

        function buildFooterHtml(check) {
            const duration = typeof check.duration_ms === "number"
                ? check.duration_ms.toFixed(1)
                : "0.0";

            let html = `
                <div class="detail-row">
                    <span>Lat√™ncia:</span>
                    <span>${duration} ms</span>
                </div>
            `;

            if (check.details) {
                for (const [key, value] of Object.entries(check.details)) {
                    const label = key
                        .replace(/_/g, " ")
                        .replace(/\b\w/g, c => c.toUpperCase());

                    html += `
                        <div class="detail-row">
                            <span>${label}:</span>
                            <span style="color:#cbd5e1;">${value}</span>
                        </div>
                    `;
                }
            }

            return html;
        }

        function applyHealthData(data) {
            if (!data || !data.checks) return;

            // Atualiza badge global
            updateGlobalStatus(data.status);

            const checks = data.checks;
            const metrics = data.metrics || {};
            const keys = ["system", "internet", "database", "google_auth", "disk", "tasks"];

            keys.forEach(key => {
                const check = checks[key];
                if (!check) return;

                const card = document.querySelector(`.health-card[data-check="${key}"]`);
                if (!card) return;

                // Borda do card
                card.classList.remove("card-ok", "card-warning", "card-error");
                card.classList.add(statusToCardClass(check.status));

                // √çcone
                const iconEl = card.querySelector('[data-role="status-icon"]');
                if (iconEl) {
                    iconEl.textContent = statusToEmoji(check.status);
                }

                // Mensagem principal
                const msgEl = card.querySelector('[data-role="message"]');
                if (msgEl && typeof check.message === "string") {
                    msgEl.textContent = check.message;
                }

                // Rodap√© (lat√™ncia + detalhes)
                const footerEl = card.querySelector('[data-role="footer"]');
                if (footerEl) {
                    footerEl.innerHTML = buildFooterHtml(check);
                }
            });

            // Atualiza os gr√°ficos em tempo real
            updateChartsFromSample(data, metrics);
        }

        function pushPoint(arr, value) {
            arr.push(value);
            if (arr.length > MAX_POINTS) {
                arr.shift();
            }
        }

        function updateChartsFromSample(data, metrics) {
            const ts = data.timestamp ? new Date(data.timestamp * 1000) : new Date();
            const label = ts.toLocaleTimeString("pt-BR", { hour12: false });

            const system = data.checks.system || {};
            const disk = data.checks.disk || {};

            const cpuStr = system.details && system.details.cpu_usage || "0";
            const ramStr = system.details && system.details.ram_usage || "0";
            const diskFreeStr = disk.details && disk.details.percent_free || "0";

            const cpuVal = parseFloat(String(cpuStr).replace("%", "")) || 0;
            const ramVal = parseFloat(String(ramStr).replace("%", "")) || 0;
            const diskFreeVal = parseFloat(String(diskFreeStr).replace("%", "")) || 0;

            const jobs = metrics.jobs || {};
            const backups = metrics.backups || {};
            const throughput = metrics.throughput || {};

            const running = jobs.running || 0;
            const pending = jobs.pending || 0;
            const failed24h = jobs.failed_24h || 0;

            const avgSpeed = throughput.avg_download_speed_mb_s || 0;
            const lastSpeed = throughput.last_download_speed_mb_s || 0;
            const lastCompression = backups.last_compression_ratio || 0;

            if (series.labels.length >= MAX_POINTS) {
                series.labels.shift();
            }
            series.labels.push(label);

            pushPoint(series.cpu, cpuVal);
            pushPoint(series.ram, ramVal);
            pushPoint(series.diskFree, diskFreeVal);
            pushPoint(series.runningJobs, running);
            pushPoint(series.pendingJobs, pending);
            pushPoint(series.failed24h, failed24h);
            pushPoint(series.avgSpeed, avgSpeed);
            pushPoint(series.lastSpeed, lastSpeed);
            pushPoint(series.lastCompression, lastCompression);

            // Atualiza meta texts
            const cpuMeta = document.getElementById("chart-cpu-ram-meta");
            if (cpuMeta) {
                cpuMeta.textContent = `CPU atual: ${cpuVal.toFixed(1)}% ‚Ä¢ RAM atual: ${ramVal.toFixed(1)}%`;
            }

            const jobsMeta = document.getElementById("chart-jobs-meta");
            if (jobsMeta) {
                jobsMeta.textContent = `Ativos: ${running} ‚Ä¢ Pendentes: ${pending} ‚Ä¢ Falhas 24h: ${failed24h}`;
            }

            const thrMeta = document.getElementById("chart-throughput-meta");
            if (thrMeta) {
                thrMeta.textContent = `Vel. m√©dia: ${avgSpeed.toFixed(2)} MB/s ‚Ä¢ Ult. comp.: x${lastCompression.toFixed(2)}`;
            }

            if (cpuRamChart) cpuRamChart.update();
            if (jobsChart) jobsChart.update();
            if (throughputChart) throughputChart.update();
        }

        function createCharts() {
            const cpuCtx = document.getElementById("chart-cpu-ram");
            const jobsCtx = document.getElementById("chart-jobs-failures");
            const thrCtx = document.getElementById("chart-throughput");

            if (cpuCtx) {
                cpuRamChart = new Chart(cpuCtx, {
                    type: "line",
                    data: {
                        labels: series.labels,
                        datasets: [
                            {
                                label: "CPU %",
                                data: series.cpu,
                                fill: false,
                                tension: 0.3,
                            },
                            {
                                label: "RAM %",
                                data: series.ram,
                                fill: false,
                                tension: 0.3,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: "#e5e7eb",
                                },
                            },
                        },
                        scales: {
                            x: {
                                ticks: { color: "#9ca3af", maxTicksLimit: 6 },
                            },
                            y: {
                                ticks: { color: "#9ca3af" },
                                beginAtZero: true,
                                suggestedMax: 100,
                            },
                        },
                    },
                });
            }

            if (jobsCtx) {
                jobsChart = new Chart(jobsCtx, {
                    type: "bar",
                    data: {
                        labels: series.labels,
                        datasets: [
                            {
                                label: "Jobs Ativos",
                                data: series.runningJobs,
                                stack: "jobs",
                            },
                            {
                                label: "Jobs Pendentes",
                                data: series.pendingJobs,
                                stack: "jobs",
                            },
                            {
                                label: "Falhas 24h",
                                data: series.failed24h,
                                stack: "falhas",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: "#e5e7eb",
                                },
                            },
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: "#9ca3af", maxTicksLimit: 6 },
                            },
                            y: {
                                stacked: true,
                                ticks: { color: "#9ca3af" },
                                beginAtZero: true,
                            },
                        },
                    },
                });
            }

            if (thrCtx) {
                throughputChart = new Chart(thrCtx, {
                    type: "line",
                    data: {
                        labels: series.labels,
                        datasets: [
                            {
                                label: "Vel. m√©dia (MB/s)",
                                data: series.avgSpeed,
                                fill: false,
                                tension: 0.3,
                            },
                            {
                                label: "Vel. √∫ltima (MB/s)",
                                data: series.lastSpeed,
                                fill: false,
                                tension: 0.3,
                            },
                            {
                                label: "Comp. √∫ltima (x)",
                                data: series.lastCompression,
                                fill: false,
                                tension: 0.3,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: "#e5e7eb",
                                },
                            },
                        },
                        scales: {
                            x: {
                                ticks: { color: "#9ca3af", maxTicksLimit: 6 },
                            },
                            y: {
                                ticks: { color: "#9ca3af" },
                                beginAtZero: true,
                            },
                        },
                    },
                });
            }
        }

        function fetchHealth() {
            fetch("/health", { cache: "no-store" })
                .then(resp => resp.json())
                .then(applyHealthData)
                .catch(err => {
                    console.error("Erro ao atualizar /health:", err);
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            createCharts();
            fetchHealth();
            setInterval(fetchHealth, POLL_INTERVAL_MS);
        });
    })();
</script>
{% endblock %}
