<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pastas do Google Drive</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="bg-gradient">
    <div class="page">
        <div class="card">
            <h1>üìÅ Escolha pastas e arquivos para baixar</h1>
            <p class="subtitle">
                Selecione um ou mais itens do seu Google Drive na √°rvore abaixo.
                A √°rvore √© carregada de forma din√¢mica conforme voc√™ expande as pastas.
            </p>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="alert">
                {% for msg in messages %}
                <p>{{ msg }}</p>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- INFO DE SELE√á√ÉO -->
            <div style="margin-bottom:8px;">
                <span class="selected-label">Itens selecionados:</span>
                <span id="selected-folder-label" class="selected-name">nenhum</span>
            </div>
            <div id="selection-counter" class="selection-counter">
                Nenhum item selecionado.
            </div>

            <!-- TOOLBAR DA TREE -->
            <div class="tree-toolbar">
                <label class="checkbox-inline">
                    <input type="checkbox" id="toggle-files">
                    Mostrar arquivos tamb√©m
                </label>

                <button type="button" class="btn-primary btn-xs" onclick="openModalForSelected()">
                    Baixar itens selecionados
                </button>
            </div>

            <!-- FAVORITOS -->
            <div class="favorites-box">
                <div class="favorites-header">
                    <span>‚≠ê Favoritos</span>
                    <small>(clique na estrela ao lado de uma pasta para favoritar)</small>
                </div>
                <div id="favorites-list" class="favorites-list">
                    Nenhum favorito ainda.
                </div>
            </div>

            <!-- PERFIS DE BACKUP -->
            <div class="profiles-box">
                <div class="favorites-header">
                    <span>‚öôÔ∏è Modelos de backup</span>
                    <small>Salve configura√ß√µes frequentes e rode o backup com 1 clique.</small>
                </div>
                <div id="profiles-list" class="favorites-list">
                    Nenhum perfil de backup salvo ainda.
                </div>
            </div>

            <!-- BREADCRUMB -->
            <div class="breadcrumb-box">
                <span class="breadcrumb-label">Caminho:</span>
                <span id="breadcrumb-path" class="breadcrumb-path">Meu Drive</span>
            </div>

            <!-- LAYOUT PRINCIPAL: TREE + PREVIEW -->
            <div class="main-layout">
                <!-- TREE VIEW DIN√ÇMICA -->
                <div class="tree-wrapper">
                    <ul id="tree-root" class="tree-root">
                        <!-- A √°rvore ser√° criada via JavaScript -->
                    </ul>
                </div>

                <!-- PREVIEW -->
                <aside class="preview-panel" id="preview-panel">
                    <h2 class="preview-title">Detalhes</h2>
                    <p id="preview-empty" class="preview-empty">
                        Clique em um arquivo para ver detalhes.
                    </p>

                    <div id="preview-content" class="preview-content hidden">
                        <div class="preview-name" id="preview-name"></div>

                        <div class="preview-meta">
                            <div><span class="label">Tipo:</span> <span id="preview-type"></span></div>
                            <div><span class="label">Tamanho:</span> <span id="preview-size"></span></div>
                            <div><span class="label">Modificado em:</span> <span id="preview-modified"></span></div>
                        </div>

                        <div id="preview-thumbnail-wrapper" class="preview-thumbnail-wrapper hidden">
                            <img id="preview-thumbnail" alt="Miniatura do arquivo">
                        </div>

                        <a id="preview-open-link" href="#" target="_blank" class="btn-link disabled"
                            rel="noopener noreferrer">
                            Abrir no Google Drive
                        </a>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- PROGRESSO (FLUTUANTE, FORA DO CARD) -->
    <div id="progress-container" class="progress-container progress-floating hidden">
        <div class="progress-header">
            <span id="progress-phase">Processando...</span>
            <span id="progress-percent">0%</span>
        </div>
        <div class="progress-bar-bg">
            <div id="progress-bar" class="progress-bar-fill"></div>
        </div>
        <p id="progress-text" class="progress-text"></p>
    </div>

    <!-- iframe oculto para download -->
    <iframe name="download_frame" style="display:none;"></iframe>

    <!-- Modal -->
    <!-- Modal -->
    <div id="modal-backdrop" class="modal-backdrop hidden">
        <div class="modal">
            <h2 id="modal-title">Baixar</h2>
            <p class="subtitle" id="modal-subtitle"></p>

            <form id="download-form" method="POST" action="{{ url_for('drive.download') }}" target="download_frame">
                <!-- legado (n√£o usamos mais, mas deixamos) -->
                <input type="hidden" name="folder_id" id="folder_id">
                <!-- sele√ß√£o m√∫ltipla -->
                <input type="hidden" name="items_json" id="items_json">
                <input type="hidden" name="task_id" id="task_id">

                <!-- =======================
                     Se√ß√£o 1: Arquivo de sa√≠da
                     ======================= -->
                <div class="form-section">
                    <div class="form-section-title">Arquivo de sa√≠da</div>

                    <!-- Nome base -->
                    <div class="form-group">
                        <label for="zip_name">Nome base do arquivo</label>
                        <div style="display:flex; gap:8px;">
                            <input type="text" id="zip_name" name="zip_name" placeholder="Ex: backup_drive"
                                style="flex:1;">
                            <button type="button" class="btn-ghost btn-xs" onclick="suggestZipName()">
                                Sugest√£o de nome
                            </button>
                        </div>
                        <small>N√£o precisa colocar extens√£o, ela ser√° adicionada automaticamente üòâ</small>
                    </div>

                    <!-- Modo de sa√≠da -->
                    <div class="form-group">
                        <label for="output_mode">Modo de sa√≠da</label>
                        <select id="output_mode" name="output_mode">
                            <option value="archive" selected>Arquivo compactado (ZIP/Tar.gz)</option>
                            <option value="mirror">Espelho local (sincronizar em pasta)</option>
                        </select>
                        <small>Use "Espelho local" para baixar direto para uma pasta deste servidor.</small>
                    </div>

                    <!-- Formato (apenas modo arquivo) -->
                    <div class="form-group archive-only">
                        <label for="archive_format">Formato do arquivo</label>
                        <select id="archive_format" name="archive_format">
                            <option value="zip">ZIP (.zip)</option>
                            <option value="tar.gz">Tar GZip (.tar.gz)</option>
                        </select>
                    </div>

                    <!-- Compress√£o (apenas modo arquivo) -->
                    <div class="form-group archive-only">
                        <label for="compression_level">N√≠vel de compress√£o</label>
                        <select id="compression_level" name="compression_level">
                            <option value="fast">R√°pido (menos compactado)</option>
                            <option value="normal" selected>Equilibrado</option>
                            <option value="max">M√°ximo (mais lento)</option>
                        </select>
                    </div>

                    <!-- Pasta local do espelho -->
                    <div class="form-group mirror-only" style="display:none;">
                        <label for="local_mirror_path">Pasta local do espelho</label>
                        <input type="text" id="local_mirror_path" name="local_mirror_path"
                            placeholder="/home/user/Backups/Drive/ClienteA">
                        <small>Os arquivos ser√£o salvos nessa pasta base, respeitando a estrutura de subpastas.</small>
                    </div>
                </div>

                <!-- =======================
                     Se√ß√£o 2: Tipos de arquivo
                     ======================= -->
                <div class="form-section">
                    <div class="form-section-title">Tipos de arquivo</div>

                    <div class="form-group">
                        <label>Tipos de arquivo a incluir</label>
                        <div class="filter-types">
                            <label><input type="checkbox" name="type_pdf" value="1" checked> PDF</label>
                            <label><input type="checkbox" name="type_docs" value="1" checked> Docs /
                                Apresenta√ß√µes</label>
                            <label><input type="checkbox" name="type_sheets" value="1" checked> Planilhas</label>
                            <label><input type="checkbox" name="type_images" value="1" checked> Imagens</label>
                            <label><input type="checkbox" name="type_videos" value="1" checked> V√≠deos</label>
                            <label><input type="checkbox" name="type_others" value="1" checked> Outros</label>
                        </div>
                        <small>Desmarque os tipos que n√£o quiser incluir no pacote/espelho.</small>
                    </div>
                </div>

                <!-- =======================
                     Se√ß√£o 3: Filtros avan√ßados
                     ======================= -->
                <div class="form-section">
                    <div class="form-section-title">Filtros avan√ßados</div>

                    <div class="form-group">
                        <label>Filtro por data (opcional)</label>
                        <div class="filter-dates">
                            <label>
                                Criados depois de:
                                <input type="date" name="created_after">
                            </label>
                            <label>
                                Atualizados depois de:
                                <input type="date" name="modified_after">
                            </label>
                        </div>
                        <small>Deixe em branco para n√£o filtrar por data.</small>
                    </div>

                    <div class="form-group">
                        <label for="max_size_mb">Ignorar arquivos maiores que (MB)</label>
                        <input type="number" id="max_size_mb" name="max_size_mb" min="0" step="1" placeholder="Ex: 100">
                        <small>Ex.: 100 = ignora arquivos maiores que 100MB. Deixe vazio para n√£o limitar.</small>
                    </div>
                </div>

                <!-- Rodap√© -->
                <div class="modal-footer">
                    <div>
                        <button type="button" class="btn-ghost" onclick="closeModal()">Cancelar</button>
                        <button type="button" class="btn-ghost" onclick="saveCurrentAsProfile()">Salvar como
                            modelo</button>
                    </div>
                    <button type="button" class="btn-primary" onclick="startDownload()">
                        Baixar pacote / atualizar espelho
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        let currentTaskId = null;
        let progressTimer = null;
        let includeFiles = false;
        let selectedItems = [];   // {id, name, type}
        let selectedNodeIds = new Set();
        let favorites = [];       // {id, name, path}
        let backupProfiles = [];  // perfis de backup

        // ---------- UTILS ----------

        function humanSize(bytes) {
            if (!bytes || isNaN(bytes)) return '‚Äî';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            let v = bytes;
            while (v >= 1024 && i < units.length - 1) {
                v /= 1024;
                i++;
            }
            return (i === 0 ? v.toFixed(0) : v.toFixed(1)) + ' ' + units[i];
        }

        function computeBreadcrumb(li) {
            const parts = [];
            let node = li;
            while (node) {
                const name = node.dataset.name ||
                    (node.querySelector(':scope > .tree-row .tree-name')?.textContent || '').trim();
                if (name) parts.unshift(name);
                node = node.parentElement.closest('.tree-node');
            }
            return parts.join(' / ');
        }

        function updateBreadcrumbFromNode(li) {
            const pathSpan = document.getElementById('breadcrumb-path');
            if (!pathSpan || !li) return;
            const crumb = computeBreadcrumb(li);
            pathSpan.textContent = crumb || 'Meu Drive';
        }

        // ---------- FAVORITOS ----------

        function loadFavorites() {
            try {
                const raw = localStorage.getItem('gpacker_favorites');
                favorites = raw ? JSON.parse(raw) : [];
            } catch (e) {
                favorites = [];
            }
        }

        function saveFavorites() {
            try {
                localStorage.setItem('gpacker_favorites', JSON.stringify(favorites));
            } catch (e) { }
        }

        function isFavorite(id) {
            return favorites.some(f => f.id === id);
        }

        function renderFavorites() {
            const box = document.getElementById('favorites-list');
            if (!box) return;
            box.innerHTML = '';

            if (!favorites.length) {
                box.textContent = 'Nenhum favorito ainda.';
                return;
            }

            favorites.forEach(fav => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'favorite-item';
                btn.textContent = '‚≠ê ' + (fav.path || fav.name);
                btn.addEventListener('click', () => {
                    focusNodeById(fav.id);
                });
                box.appendChild(btn);
            });
        }

        function toggleFavorite(item, li, favBtn) {
            const path = computeBreadcrumb(li);
            if (isFavorite(item.id)) {
                favorites = favorites.filter(f => f.id !== item.id);
                favBtn.classList.remove('fav-on');
            } else {
                favorites.push({ id: item.id, name: item.name, path });
                favBtn.classList.add('fav-on');
            }
            saveFavorites();
            renderFavorites();
        }

        function focusNodeById(id) {
            const node = document.querySelector(`.tree-node[data-id="${id}"]`);
            if (!node) return;

            // Expande todos os pais
            let current = node.parentElement.closest('.tree-node');
            while (current) {
                const toggle = current.querySelector(':scope > .tree-row .tree-toggle');
                if (toggle && current.classList.contains('collapsed')) {
                    toggle.click();
                }
                current = current.parentElement.closest('.tree-node');
            }

            node.scrollIntoView({ behavior: 'smooth', block: 'center' });
            node.classList.add('tree-node-highlight');
            setTimeout(() => node.classList.remove('tree-node-highlight'), 1500);
        }

        // ---------- PERFIS DE BACKUP ----------

        function applyZipPattern(pattern) {
            if (!pattern) {
                pattern = "backup-{YYYYMMDD}";
            }
            const now = new Date();
            const yyyy = now.getFullYear();
            const yy = String(yyyy).slice(-2);
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');

            let name = pattern;
            name = name.replace(/\{YYYYMMDD\}/g, `${yyyy}${mm}${dd}`);
            name = name.replace(/\{YYYYMM\}/g, `${yyyy}${mm}`);
            name = name.replace(/\{YYYY\}/g, String(yyyy));
            name = name.replace(/\{YY\}/g, yy);
            name = name.replace(/\{MM\}/g, mm);
            name = name.replace(/\{DD\}/g, dd);

            // Remove caracteres inv√°lidos para nome de arquivo
            name = name.replace(/[\\/:*?"<>|]/g, "_");
            return name;
        }

        function loadProfiles() {
            fetch('/api/profiles')
                .then(resp => resp.json())
                .then(data => {
                    backupProfiles = data.profiles || [];
                    renderProfiles();
                })
                .catch(err => {
                    console.error('Erro ao carregar perfis de backup:', err);
                    const box = document.getElementById('profiles-list');
                    if (box) {
                        box.textContent = 'Erro ao carregar perfis.';
                    }
                });
        }

        function renderProfiles() {
            const box = document.getElementById('profiles-list');
            if (!box) return;

            box.innerHTML = '';

            if (!backupProfiles.length) {
                box.textContent = 'Nenhum perfil de backup salvo ainda.';
                return;
            }

            backupProfiles.forEach(profile => {
                const wrapper = document.createElement('div');
                wrapper.className = 'profile-item';

                const title = document.createElement('div');
                title.className = 'profile-title';
                title.textContent = profile.name || '(sem nome)';

                const subtitle = document.createElement('div');
                subtitle.className = 'profile-subtitle';
                const pattern = profile.zip_pattern || 'backup-{YYYYMMDD}';
                const exampleName = applyZipPattern(pattern);
                subtitle.textContent = `Nome base: ${exampleName} ‚Ä¢ Tipo: ${profile.output_mode === 'mirror' ? 'Espelho local' : 'Arquivo compactado'}`;

                const actions = document.createElement('div');
                actions.className = 'profile-actions';

                const runButton = document.createElement('button');
                runButton.type = 'button';
                runButton.className = 'btn-primary btn-xs';
                runButton.textContent = 'Rodar agora';
                runButton.addEventListener('click', () => {
                    runBackupProfile(profile.id, true);
                });

                const prepareButton = document.createElement('button');
                prepareButton.type = 'button';
                prepareButton.className = 'btn-ghost btn-xs';
                prepareButton.textContent = 'Abrir detalhes';
                prepareButton.addEventListener('click', () => {
                    runBackupProfile(profile.id, false);
                });

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'btn-ghost btn-xs';
                deleteButton.textContent = 'Excluir';
                deleteButton.addEventListener('click', () => {
                    if (!confirm(`Remover o perfil "${profile.name}"?`)) return;
                    deleteProfile(profile.id);
                });

                actions.appendChild(runButton);
                actions.appendChild(prepareButton);
                actions.appendChild(deleteButton);

                wrapper.appendChild(title);
                wrapper.appendChild(subtitle);
                wrapper.appendChild(actions);

                box.appendChild(wrapper);
            });
        }

        function deleteProfile(id) {
            fetch('/api/profiles/' + encodeURIComponent(id), {
                method: 'DELETE'
            })
                .then(resp => resp.json())
                .then(data => {
                    if (!data.ok) {
                        alert(data.error || 'Erro ao excluir perfil.');
                        return;
                    }
                    backupProfiles = backupProfiles.filter(p => p.id !== id);
                    renderProfiles();
                })
                .catch(err => {
                    console.error('Erro ao excluir perfil:', err);
                    alert('Erro ao excluir perfil.');
                });
        }

        function collectCurrentFiltersFromForm() {
            const groups = [];
            if (document.querySelector('input[name="type_pdf"]')?.checked) groups.push('pdf');
            if (document.querySelector('input[name="type_docs"]')?.checked) groups.push('docs');
            if (document.querySelector('input[name="type_sheets"]')?.checked) groups.push('sheets');
            if (document.querySelector('input[name="type_images"]')?.checked) groups.push('images');
            if (document.querySelector('input[name="type_videos"]')?.checked) groups.push('videos');
            if (document.querySelector('input[name="type_others"]')?.checked) groups.push('others');

            const createdAfter = document.querySelector('input[name="created_after"]')?.value || null;
            const modifiedAfter = document.querySelector('input[name="modified_after"]')?.value || null;
            const maxSizeStr = document.getElementById('max_size_mb')?.value || '';
            const outputMode = document.getElementById('output_mode')?.value || 'archive';
            const localPath = document.getElementById('local_mirror_path')?.value || '';
            const archiveFormat = document.getElementById('archive_format')?.value || 'zip';
            const compressionLevel = document.getElementById('compression_level')?.value || 'normal';

            let maxSizeMb = null;
            if (maxSizeStr) {
                const parsed = parseInt(maxSizeStr, 10);
                if (!Number.isNaN(parsed)) {
                    maxSizeMb = parsed;
                }
            }

            return {
                groups,
                created_after: createdAfter,
                modified_after: modifiedAfter,
                max_size_mb: maxSizeMb,
                output_mode: outputMode,
                local_mirror_path: localPath,
                archive_format: archiveFormat,
                compression_level: compressionLevel,
            };
        }

        function saveCurrentAsProfile() {
            if (!selectedItems.length) {
                alert("Selecione pelo menos um arquivo ou pasta para salvar como modelo.");
                return;
            }

            const name = prompt("Nome do modelo de backup:");
            if (!name) {
                return;
            }

            const zipInput = document.getElementById('zip_name');
            const currentBase = (zipInput && zipInput.value.trim()) || 'backup';
            const defaultPattern = currentBase.includes('{')
                ? currentBase
                : currentBase + "-{YYYYMMDD}";

            const pattern = prompt(
                "Regra de nome do arquivo (use {YYYY}, {YY}, {MM}, {DD}, {YYYYMM}, {YYYYMMDD}):",
                defaultPattern
            ) || defaultPattern;

            const filters = collectCurrentFiltersFromForm();

            const payload = {
                name: name,
                zip_pattern: pattern,
                items: selectedItems,
                groups: filters.groups,
                created_after: filters.created_after,
                modified_after: filters.modified_after,
                max_size_mb: filters.max_size_mb,
                archive_format: filters.archive_format,
                compression_level: filters.compression_level,
                output_mode: filters.output_mode,
                local_mirror_path: filters.local_mirror_path,
            };

            fetch('/api/profiles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(resp => resp.json())
                .then(data => {
                    if (!data.ok) {
                        alert(data.error || 'N√£o foi poss√≠vel salvar o modelo.');
                        return;
                    }
                    if (data.profile) {
                        backupProfiles.push(data.profile);
                        renderProfiles();
                    } else {
                        loadProfiles();
                    }
                    alert('Modelo salvo com sucesso!');
                })
                .catch(err => {
                    console.error('Erro ao salvar modelo:', err);
                    alert('Erro ao salvar modelo.');
                });
        }

        function applyFiltersToFormFromProfile(profile) {
            // tipos
            const allTypeNames = ['pdf', 'docs', 'sheets', 'images', 'videos', 'others'];
            const groups = profile.groups || [];
            allTypeNames.forEach(g => {
                const input = document.querySelector(`input[name="type_${g}"]`);
                if (input) {
                    input.checked = !groups.length || groups.includes(g);
                }
            });

            // datas
            if (profile.created_after !== undefined) {
                const createdInput = document.querySelector('input[name="created_after"]');
                if (createdInput) createdInput.value = profile.created_after || '';
            }
            if (profile.modified_after !== undefined) {
                const modifiedInput = document.querySelector('input[name="modified_after"]');
                if (modifiedInput) modifiedInput.value = profile.modified_after || '';
            }

            // tamanho
            const maxSizeInput = document.getElementById('max_size_mb');
            if (maxSizeInput) {
                maxSizeInput.value = profile.max_size_mb != null ? String(profile.max_size_mb) : '';
            }

            // modo de sa√≠da / pasta local
            const outputModeSelect = document.getElementById('output_mode');
            if (outputModeSelect && profile.output_mode) {
                outputModeSelect.value = profile.output_mode;
            }
            const localPathInput = document.getElementById('local_mirror_path');
            if (localPathInput && profile.local_mirror_path) {
                localPathInput.value = profile.local_mirror_path;
            }

            const archiveFormatSelect = document.getElementById('archive_format');
            if (archiveFormatSelect && profile.archive_format) {
                archiveFormatSelect.value = profile.archive_format;
            }
            const compressionSelect = document.getElementById('compression_level');
            if (compressionSelect && profile.compression_level) {
                compressionSelect.value = profile.compression_level;
            }

            updateOutputModeUI();
        }

        function runBackupProfile(profileId, autoRun) {
            const profile = backupProfiles.find(p => p.id === profileId);
            if (!profile) {
                alert('Perfil n√£o encontrado.');
                return;
            }

            // atualiza sele√ß√£o global (n√£o for√ßa checkboxes na √°rvore, mas mant√©m contador coerente)
            selectedItems = profile.items || [];
            selectedNodeIds = new Set();
            (selectedItems || []).forEach(it => {
                selectedNodeIds.add(`${it.type}:${it.id}`);
            });
            updateSelectionInfo();

            // Preenche form
            const formItemsInput = document.getElementById('items_json');
            if (formItemsInput) {
                formItemsInput.value = JSON.stringify(selectedItems);
            }

            const zipInput = document.getElementById('zip_name');
            if (zipInput) {
                const baseName = applyZipPattern(profile.zip_pattern || 'backup-{YYYYMMDD}');
                zipInput.value = baseName;
            }

            applyFiltersToFormFromProfile(profile);

            if (autoRun) {
                startDownload();
            } else {
                // Abre modal para o usu√°rio revisar
                openModalForSelected();
            }
        }

        // ---------- MODAL / DOWNLOAD ----------

        function updateOutputModeUI() {
            const modeSelect = document.getElementById('output_mode');
            const mode = modeSelect ? modeSelect.value : 'archive';

            const archiveFields = document.querySelectorAll('.archive-only');
            const mirrorFields = document.querySelectorAll('.mirror-only');

            archiveFields.forEach(el => {
                el.style.display = mode === 'archive' ? 'block' : 'none';
            });
            mirrorFields.forEach(el => {
                el.style.display = mode === 'mirror' ? 'block' : 'none';
            });
        }

        function openModalForSelected() {
            if (!selectedItems.length) {
                alert("Selecione pelo menos um arquivo ou pasta.");
                return;
            }

            document.getElementById('items_json').value = JSON.stringify(selectedItems);

            const titleEl = document.getElementById('modal-title');
            const subtitleEl = document.getElementById('modal-subtitle');
            const zipInput = document.getElementById('zip_name');

            zipInput.value = "";

            if (selectedItems.length === 1) {
                const it = selectedItems[0];
                titleEl.innerText = it.type === 'file' ? 'Baixar arquivo' : 'Baixar pasta';
                const prefix = it.type === 'file' ? '[Arquivo] ' : '[Pasta] ';
                subtitleEl.innerText = 'Selecionado: ' + prefix + it.name;
            } else {
                const folders = selectedItems.filter(i => i.type === 'folder').length;
                const files = selectedItems.filter(i => i.type === 'file').length;
                titleEl.innerText = 'Baixar itens selecionados';
                subtitleEl.innerText =
                    `Voc√™ selecionou ${folders} pastas e ${files} arquivos.`;
            }

            updateOutputModeUI();
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }

        function startDownload() {
            if (!selectedItems.length && !document.getElementById('items_json').value) {
                alert("Nenhum item selecionado.");
                return;
            }

            const taskId = 'task-' + Date.now();
            currentTaskId = taskId;
            document.getElementById('task_id').value = taskId;

            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-percent').innerText = '0%';
            document.getElementById('progress-phase').innerText = 'INICIANDO';
            document.getElementById('progress-text').innerText = 'Iniciando processo...';

            if (progressTimer) {
                clearInterval(progressTimer);
            }
            progressTimer = setInterval(fetchProgress, 1500);

            document.getElementById('download-form').submit();
            closeModal();
        }

        function fetchProgress() {
            if (!currentTaskId) return;

            fetch('/progress/' + currentTaskId)
                .then(resp => resp.json())
                .then(data => {
                    const phase = data.phase || 'processando';
                    let percent = 0;

                    if (phase === 'mapeando') {
                        const found = data.files_found || 0;
                        const total = data.files_total || 1;
                        percent = Math.min(30, (found / total) * 30);
                    } else if (phase === 'baixando') {
                        if (data.files_total > 0) {
                            percent = 30 + Math.min(60, (data.files_downloaded / data.files_total) * 60);
                        } else {
                            percent = 40;
                        }
                    } else if (phase === 'compactando') {
                        percent = 95;
                    } else if (phase === 'concluido') {
                        percent = 100;
                        clearInterval(progressTimer);
                    } else if (phase === 'erro') {
                        clearInterval(progressTimer);
                    }

                    percent = Math.round(percent);
                    document.getElementById('progress-bar').style.width = percent + '%';
                    document.getElementById('progress-percent').innerText = percent + '%';
                    document.getElementById('progress-phase').innerText = phase.toUpperCase();
                    document.getElementById('progress-text').innerText = data.message || '';
                })
                .catch(err => console.error(err));
        }

        function suggestZipName() {
            if (!selectedItems.length) {
                alert("Selecione pelo menos um item para sugerir o nome.");
                return;
            }

            let base = "";
            if (selectedItems.length === 1) {
                const name = selectedItems[0].name;
                base = name.includes('.') ? name.substring(0, name.lastIndexOf('.')) : name;
            } else {
                const folders = selectedItems.filter(i => i.type === 'folder');
                if (folders.length === 1) {
                    base = folders[0].name + "-multi";
                } else if (folders.length > 1) {
                    base = folders[0].name + "-e-outros";
                } else {
                    base = "backup";
                }
            }

            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');

            const suggestion = `${base}-${yyyy}${mm}${dd}`;
            document.getElementById('zip_name').value = suggestion;
        }

        // --------- TREE VIEW ASS√çNCRONA & SELE√á√ÉO ---------

        function setCollapsedState(li, collapsed) {
            const childrenUl = li.querySelector(':scope > .tree-children');
            if (!childrenUl) return;

            if (collapsed) {
                li.classList.add('collapsed');
                childrenUl.style.display = 'none';
            } else {
                li.classList.remove('collapsed');
                childrenUl.style.display = 'block';
            }
        }

        function updateSelectionInfo() {
            const label = document.getElementById('selected-folder-label');
            const counter = document.getElementById('selection-counter');

            if (!selectedItems.length) {
                if (label) label.textContent = 'nenhum';
                if (counter) counter.textContent = 'Nenhum item selecionado.';
                return;
            }

            const folders = selectedItems.filter(i => i.type === 'folder').length;
            const files = selectedItems.filter(i => i.type === 'file').length;

            const resumo = `${folders} pastas e ${files} arquivos selecionados`;

            if (label) label.textContent = resumo;
            if (counter) counter.textContent = resumo;
        }

        // Marca/desmarca item na lista global
        function handleCheckboxChange(checkbox, li, item, updateParents = true) {
            const key = item.type + ":" + item.id;

            if (checkbox && checkbox.checked) {
                if (!selectedNodeIds.has(key)) {
                    selectedNodeIds.add(key);
                    selectedItems.push(item);
                }
                li.classList.add('tree-node-selected');
                updateBreadcrumbFromNode(li);
            } else {
                if (selectedNodeIds.has(key)) {
                    selectedNodeIds.delete(key);
                    selectedItems = selectedItems.filter(it => !(it.id === item.id && it.type === item.type));
                }
                li.classList.remove('tree-node-selected');
            }

            updateSelectionInfo();

            if (updateParents) {
                propagateSelectionUp(li);
            }
        }

        // Marca ou desmarca um n√≥ e TODOS os seus filhos
        function setNodeCheckedDeep(li, checked) {
            const checkbox = li.querySelector(':scope > .tree-row .select-checkbox');
            if (checkbox) {
                checkbox.checked = checked;
                checkbox.indeterminate = false;
            }

            const item = {
                id: li.dataset.id,
                name: li.dataset.name,
                type: li.dataset.type
            };
            handleCheckboxChange(checkbox, li, item, false); // n√£o sobe ainda

            const children = li.querySelectorAll(':scope > .tree-children > .tree-node');
            children.forEach(child => {
                setNodeCheckedDeep(child, checked);
            });
        }

        function updateParentSelection(li) {
            const parentLi = li.parentElement.closest('.tree-node');
            if (!parentLi) return;

            const childCheckboxes = parentLi.querySelectorAll(':scope > .tree-children > .tree-node > .tree-row .select-checkbox');
            const all = Array.from(childCheckboxes);
            if (!all.length) return;

            const allChecked = all.every(cb => cb.checked);
            const someChecked = all.some(cb => cb.checked);

            const parentCheckbox = parentLi.querySelector(':scope > .tree-row .select-checkbox');
            if (!parentCheckbox) return;

            parentCheckbox.checked = allChecked;
            parentCheckbox.indeterminate = !allChecked && someChecked;

            const item = {
                id: parentLi.dataset.id,
                name: parentLi.dataset.name,
                type: parentLi.dataset.type
            };
            handleCheckboxChange(parentCheckbox, parentLi, item, false);

            updateParentSelection(parentLi);
        }

        function propagateSelectionDown(li, checked) {
            setNodeCheckedDeep(li, checked);
        }

        function propagateSelectionUp(li) {
            updateParentSelection(li);
        }

        // --------- PREVIEW ---------

        function showFilePreview(item, li) {
            if (item.type !== 'file') return;

            const empty = document.getElementById('preview-empty');
            const content = document.getElementById('preview-content');
            const thumbWrapper = document.getElementById('preview-thumbnail-wrapper');
            const thumbImg = document.getElementById('preview-thumbnail');

            empty.classList.add('hidden');
            content.classList.remove('hidden');

            document.getElementById('preview-name').textContent = item.name;
            document.getElementById('preview-type').textContent = 'Carregando...';
            document.getElementById('preview-size').textContent = 'Carregando...';
            document.getElementById('preview-modified').textContent = 'Carregando...';
            document.getElementById('preview-open-link').classList.add('disabled');
            thumbWrapper.classList.add('hidden');
            thumbImg.src = '';

            updateBreadcrumbFromNode(li);

            fetch('/api/file/' + encodeURIComponent(item.id))
                .then(r => r.json())
                .then(meta => {
                    document.getElementById('preview-type').textContent = meta.mimeType || '‚Äî';
                    document.getElementById('preview-size').textContent = humanSize(parseInt(meta.size || '0', 10));

                    if (meta.modifiedTime) {
                        const d = new Date(meta.modifiedTime);
                        document.getElementById('preview-modified').textContent = d.toLocaleString('pt-BR');
                    } else {
                        document.getElementById('preview-modified').textContent = '‚Äî';
                    }

                    const linkEl = document.getElementById('preview-open-link');
                    if (meta.webViewLink) {
                        linkEl.href = meta.webViewLink;
                        linkEl.classList.remove('disabled');
                    } else {
                        linkEl.href = '#';
                        linkEl.classList.add('disabled');
                    }

                    if (meta.thumbnailLink) {
                        thumbImg.src = meta.thumbnailLink;
                        thumbWrapper.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('preview-type').textContent = 'Erro ao carregar detalhes.';
                    document.getElementById('preview-size').textContent = '‚Äî';
                    document.getElementById('preview-modified').textContent = '‚Äî';
                });
        }

        // --------- Cria√ß√£o dos n√≥s ---------

        function createFolderNode(folder) {
            const li = document.createElement('li');
            li.className = 'tree-node collapsed';
            li.dataset.id = folder.id;
            li.dataset.name = folder.name;
            li.dataset.type = 'folder';

            const row = document.createElement('div');
            row.className = 'tree-row';

            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'tree-toggle';
            toggleBtn.textContent = '‚ñ∏';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-checkbox';

            const favBtn = document.createElement('button');
            favBtn.type = 'button';
            favBtn.className = 'fav-btn';
            favBtn.textContent = '‚òÜ';

            const icon = document.createElement('span');
            icon.className = 'tree-folder-icon';
            icon.textContent = 'üìÅ';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'tree-name';
            nameSpan.textContent = folder.name;

            row.appendChild(toggleBtn);
            row.appendChild(checkbox);
            row.appendChild(favBtn);
            row.appendChild(icon);
            row.appendChild(nameSpan);

            const childrenUl = document.createElement('ul');
            childrenUl.className = 'tree-children';
            childrenUl.style.display = 'none';

            li.appendChild(row);
            li.appendChild(childrenUl);

            const item = { id: folder.id, name: folder.name, type: 'folder' };

            if (isFavorite(item.id)) {
                favBtn.classList.add('fav-on');
            }

            favBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(item, li, favBtn);
            });

            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                handleCheckboxChange(checkbox, li, item);
                propagateSelectionDown(li, checkbox.checked);
            });

            // clique na linha (exceto toggle/fav/checkbox) marca/desmarca pasta
            row.addEventListener('click', (e) => {
                if (e.target === toggleBtn || e.target === checkbox || e.target === favBtn) return;
                checkbox.checked = !checkbox.checked;
                handleCheckboxChange(checkbox, li, item);
                propagateSelectionDown(li, checkbox.checked);
            });

            // expandir/colapsar com lazy load
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isCollapsed = li.classList.contains('collapsed');

                if (isCollapsed && !li.dataset.loaded) {
                    loadChildren(folder.id, childrenUl, li, toggleBtn);
                }

                const willCollapse = !isCollapsed;
                setCollapsedState(li, willCollapse);
                toggleBtn.textContent = li.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
            });

            return li;
        }

        function createFileNode(file) {
            const li = document.createElement('li');
            li.className = 'tree-node file-node';
            li.dataset.id = file.id;
            li.dataset.name = file.name;
            li.dataset.type = 'file';

            const row = document.createElement('div');
            row.className = 'tree-row';

            const spacer = document.createElement('span');
            spacer.className = 'tree-spacer';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-checkbox';

            const icon = document.createElement('span');
            icon.className = 'tree-folder-icon';
            icon.textContent = 'üìÑ';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'tree-name';
            nameSpan.textContent = file.name;

            row.appendChild(spacer);
            row.appendChild(checkbox);
            row.appendChild(icon);
            row.appendChild(nameSpan);

            li.appendChild(row);

            const item = { id: file.id, name: file.name, type: 'file' };

            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                handleCheckboxChange(checkbox, li, item);
                propagateSelectionUp(li);
            });

            // clique na linha ‚Üí preview (n√£o altera sele√ß√£o)
            row.addEventListener('click', (e) => {
                if (e.target === checkbox) return;
                showFilePreview(item, li);
            });

            return li;
        }

        // --------- Carregamento ass√≠ncrono ---------

        function loadChildren(parentId, containerUl, li, toggleBtn) {
            const url = parentId === 'root'
                ? '/api/folders/root?files=' + (includeFiles ? '1' : '0')
                : '/api/folders/children/' + encodeURIComponent(parentId) + '?files=' + (includeFiles ? '1' : '0');

            containerUl.innerHTML = '<li class="tree-node"><div class="tree-row"><span class="tree-name">Carregando...</span></div></li>';

            fetch(url)
                .then(resp => resp.json())
                .then(data => {
                    containerUl.innerHTML = '';
                    const items = data.items || [];

                    if (!items.length) {
                        toggleBtn.textContent = '';
                        toggleBtn.classList.add('placeholder');
                        toggleBtn.disabled = true;
                        return;
                    }

                    const parentCheckbox = li.querySelector(':scope > .tree-row .select-checkbox');

                    items.forEach(it => {
                        let childNode;
                        if (it.type === 'folder') {
                            childNode = createFolderNode(it);
                        } else {
                            childNode = createFileNode(it);
                        }
                        containerUl.appendChild(childNode);

                        // se o pai j√° est√° totalmente marcado, marca novos filhos tamb√©m
                        if (parentCheckbox && parentCheckbox.checked && !parentCheckbox.indeterminate) {
                            setNodeCheckedDeep(childNode, true);
                        }
                    });

                    li.dataset.loaded = 'true';
                })
                .catch(err => {
                    console.error(err);
                    containerUl.innerHTML = '<li class="tree-node"><div class="tree-row"><span class="tree-name">Erro ao carregar.</span></div></li>';
                });
        }

        function initTree() {
            const rootUl = document.getElementById('tree-root');
            rootUl.innerHTML = '';

            const rootLi = document.createElement('li');
            rootLi.className = 'tree-node';
            rootLi.dataset.id = 'root';
            rootLi.dataset.name = 'Meu Drive';
            rootLi.dataset.type = 'folder';

            const row = document.createElement('div');
            row.className = 'tree-row';

            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'tree-toggle';
            toggleBtn.textContent = '‚ñæ';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-checkbox';

            const favBtn = document.createElement('button');
            favBtn.type = 'button';
            favBtn.className = 'fav-btn';
            favBtn.textContent = '‚òÜ';

            const icon = document.createElement('span');
            icon.className = 'tree-folder-icon';
            icon.textContent = 'üìÅ';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'tree-name';
            nameSpan.textContent = 'Meu Drive';

            row.appendChild(toggleBtn);
            row.appendChild(checkbox);
            row.appendChild(favBtn);
            row.appendChild(icon);
            row.appendChild(nameSpan);

            const childrenUl = document.createElement('ul');
            childrenUl.className = 'tree-children';

            rootLi.appendChild(row);
            rootLi.appendChild(childrenUl);
            rootUl.appendChild(rootLi);

            const rootItem = { id: 'root', name: 'Meu Drive', type: 'folder' };

            if (isFavorite(rootItem.id)) {
                favBtn.classList.add('fav-on');
            }

            favBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(rootItem, rootLi, favBtn);
            });

            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                handleCheckboxChange(checkbox, rootLi, rootItem);
                propagateSelectionDown(rootLi, checkbox.checked);
            });

            row.addEventListener('click', (e) => {
                if (e.target === toggleBtn || e.target === checkbox || e.target === favBtn) return;
                checkbox.checked = !checkbox.checked;
                handleCheckboxChange(checkbox, rootLi, rootItem);
                propagateSelectionDown(rootLi, checkbox.checked);
            });

            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isCollapsed = rootLi.classList.contains('collapsed');

                if (isCollapsed && !rootLi.dataset.loaded) {
                    loadChildren('root', childrenUl, rootLi, toggleBtn);
                }

                const willCollapse = !isCollapsed;
                setCollapsedState(rootLi, willCollapse);
                toggleBtn.textContent = rootLi.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
            });

            loadChildren('root', childrenUl, rootLi, toggleBtn);
            setCollapsedState(rootLi, false);
        }

        function reloadTree() {
            selectedItems = [];
            selectedNodeIds = new Set();
            updateSelectionInfo();
            document.getElementById('breadcrumb-path').textContent = 'Meu Drive';
            initTree();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
            renderFavorites();
            loadProfiles();

            const chk = document.getElementById('toggle-files');
            if (chk) {
                chk.addEventListener('change', () => {
                    includeFiles = chk.checked;
                    reloadTree();
                });
            }

            const outputModeSelect = document.getElementById('output_mode');
            if (outputModeSelect) {
                outputModeSelect.addEventListener('change', updateOutputModeUI);
                updateOutputModeUI();
            }

            initTree();
        });
    </script>

</body>

</html>