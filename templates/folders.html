<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pastas do Google Drive</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* =========================================
           ESTILOS ORIGINAIS (FOLDERS COMPLETO)
           ========================================= */
        .radio-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .radio-option:hover {
            background-color: #f9f9f9;
        }

        .radio-option input {
            margin-top: 4px;
        }

        .radio-option strong {
            display: block;
            font-size: 14px;
            color: #333;
        }

        .radio-option span {
            display: block;
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        .box-highlight {
            background-color: #f0f7ff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #cce5ff;
        }

        .form-hint {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .form-error {
            font-size: 12px;
            color: #b00020;
            margin-top: 4px;
        }

        .form-success {
            font-size: 12px;
            color: #0b7a0b;
            margin-top: 4px;
        }

        /* Dropdown de sugest√£o */
        .suggestion-wrapper {
            position: relative;
        }

        .suggestion-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 100;
            min-width: 200px;
        }

        .suggestion-menu.show {
            display: block;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .suggestion-item:hover {
            background: #f0f0f0;
        }

        /* Task Manager Dropdown */
        .task-dropdown-panel {
            position: absolute;
            top: 45px;
            right: 0;
            width: 350px;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        .task-dropdown-panel.show {
            display: block;
        }

        .task-manager-body {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }

        .task-item {
            border-bottom: 1px solid #eee;
            padding: 10px 15px;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-empty-state {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }

        .task-info {
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
            display: flex;
            justify-content: space-between;
        }

        .task-meta {
            font-size: 11px;
            color: #777;
            margin-bottom: 8px;
        }

        .task-progress-bg {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .task-progress-fill {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }

        .task-progress-fill.paused {
            background: #ff9800;
        }

        .task-controls {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-mini {
            padding: 4px 10px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: 600;
        }

        .btn-mini.pause {
            background: #ff9800;
        }

        .btn-mini.resume {
            background: #2196f3;
        }

        .btn-mini.cancel {
            background: #f44336;
        }

        /* Perfis */
        .profile-items-preview {
            margin-top: 8px;
            padding: 6px;
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
        }

        .profile-items-title {
            font-size: 11px;
            font-weight: 700;
            color: #555;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-item-row {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-item-row:last-child {
            margin-bottom: 0;
        }

        /* Favoritos */
        .favorite-item {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-row {
            cursor: pointer;
        }

        .tree-row:hover {
            background-color: #f0f0f0;
        }

        /* =========================================
           NOVOS ESTILOS (INTEGRA√á√ÉO DE FOLDERS.HTML)
           ABAS E ATIVIDADES
           ========================================= */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 8px 0;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background-color: #f5f5f5;
            color: #333;
        }

        .tab-btn.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.2s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Lista de Atividade */
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .activity-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .act-icon {
            width: 24px;
            height: 24px;
            background: #e8f0fe;
            color: #1a73e8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .act-details {
            flex: 1;
        }

        .act-action {
            font-size: 12px;
            font-weight: 600;
        }

        .act-meta {
            font-size: 11px;
            margin-top: 2px;
        }

        .act-date {
            font-size: 10px;
            color: #999;
            text-align: right;
            min-width: 60px;
        }

        .preview-empty-state {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 13px;
            font-style: italic;
        }

        /* =========================================
           NOVO: SCROLL PARA O PAINEL DE PREVIEW
           ========================================= */
        .tab-scrollable-area {
            max-height: 350px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: #bbb #f1f1f1;
        }

        .tab-scrollable-area::-webkit-scrollbar {
            width: 6px;
        }

        .tab-scrollable-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tab-scrollable-area::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 3px;
        }

        .tab-scrollable-area::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* Remove o estilo padr√£o feio do navegador */
input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    background-color: #fff;
    margin: 0;
    font: inherit;
    color: currentColor;
    width: 1.15em;
    height: 1.15em;
    border: 2px solid #757575; /* Borda cinza suave */
    border-radius: 4px; /* Cantos levemente arredondados */
    display: grid;
    place-content: center;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

/* Estado Marcado (Checked) */
input[type="checkbox"]:checked {
    background-color: #1a73e8; /* Azul Google */
    border-color: #1a73e8;
}

/* O "V" (Checkmark) */
input[type="checkbox"]::before {
    content: "";
    width: 0.65em;
    height: 0.65em;
    transform: scale(0);
    transition: 120ms transform ease-in-out;
    box-shadow: inset 1em 1em white; /* Cor do checkmark */
    transform-origin: center;
    clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
}

input[type="checkbox"]:checked::before {
    transform: scale(1);
}

/* Estado Hover (Ao passar o mouse) */
input[type="checkbox"]:hover {
    border-color: #1a73e8;
    background-color: #f0f7ff;
}

input[type="checkbox"]:checked:hover {
    background-color: #1557b0; /* Azul um pouco mais escuro */
}
    </style>
</head>

<body class="bg-gradient">
    <div class="page">
        <header class="page-header">
            <div class="page-header-top">
                <div>
                    <h1>üìÅ Escolha pastas e arquivos para baixar</h1>
                    <p class="subtitle">
                        Selecione itens na √°rvore. Baixe agora ou gere em segundo plano.
                    </p>
                </div>

                <div class="tree-toolbar">
                    <label class="checkbox-inline">
                        <input type="checkbox" id="toggle-files">
                        Mostrar arquivos tamb√©m
                    </label>

                    <a href="{{ url_for('admin.list_backups') }}" class="btn-ghost btn-xs"
                        style="text-decoration: none; margin-right: 4px;" target="_blank">
                        üì¶ Meus Backups
                    </a>

                    <a href="{{ url_for('admin.view_db') }}" class="btn-ghost btn-xs"
                        style="text-decoration: none; margin-right: 8px;" target="_blank">
                        üìä Admin DB
                    </a>

                    <button type="button" class="btn-primary btn-xs" onclick="openModalForSelected()">
                        Baixar itens selecionados
                    </button>

                    <div class="notification-wrapper" style="margin-left: 8px;">
                        <button class="notification-btn" onclick="toggleTaskPanel()" title="Gerenciador de Tarefas">
                            <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                                fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"></path>
                            </svg>
                            <div id="task-badge" class="notification-badge hidden">0</div>
                        </button>

                        <div id="task-manager-panel" class="task-dropdown-panel">
                            <div class="log-header"
                                style="background: #f8f9fa; border-bottom: 1px solid #eee; padding: 10px 15px; border-radius: 8px 8px 0 0; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600; font-size:14px; color:#333;">Tarefas de Segundo
                                    Plano</span>
                                <button onclick="toggleTaskPanel()" class="btn-ghost btn-xs"
                                    style="padding: 2px 6px;">‚úï</button>
                            </div>
                            <div id="task-manager-list" class="task-manager-body">
                                <div class="task-empty-state">Nenhuma tarefa ativa no momento.</div>
                            </div>
                        </div>
                    </div>

                    <div class="notification-wrapper">
                        <button class="notification-btn" id="notification-btn" onclick="toggleLogPanel()"
                            title="Logs de Atividade">
                            <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                                fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            <div id="notification-badge" class="notification-badge hidden">0</div>
                        </button>

                        <div id="log-panel" class="log-panel hidden">
                            <div class="log-header">
                                <span>Atividade Recente</span>
                                <button onclick="toggleLogPanel()" class="btn-ghost btn-xs"
                                    style="padding: 2px 6px;">‚úï</button>
                            </div>
                            <div class="log-content" id="log-content">
                                <ul class="log-list" id="log-list">
                                    <li class="log-empty">Nenhuma atividade recente.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="selection-strip">
                <span class="selected-label">Itens selecionados:</span>
                <span id="selected-folder-label" class="selected-name">nenhum</span>
                <span id="selection-counter" class="selection-counter">Nenhum item selecionado.</span>
            </div>
        </header>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="page-flash">
            <div class="alert">
                {% for msg in messages %}
                <p>{{ msg }}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endwith %}

        <!-- COLUNA ESQUERDA (FAVORITOS / MODELOS) -->
        <aside class="side-menu">
            <div class="favorites-box">
                <div class="favorites-header">
                    <span>‚≠ê Favoritos</span>
                    <small>(clique na estrela ao lado de uma pasta)</small>
                </div>
                <div id="favorites-list" class="favorites-list">
                    Carregando...
                </div>
            </div>

            <div class="profiles-box">
                <div class="favorites-header">
                    <span>‚öôÔ∏è Modelos de backup</span>
                    <small>Salve configura√ß√µes frequentes.</small>
                </div>
                <div id="profiles-list" class="favorites-list">
                    Nenhum perfil salvo.
                </div>
            </div>
        </aside>

        <!-- COLUNA CENTRAL (√ÅRVORE DE PASTAS) -->
        <main class="main-column">
            <div class="card main-card">
                <div class="breadcrumb-box">
                    <span class="breadcrumb-label">Caminho:</span>
                    <span id="breadcrumb-path" class="breadcrumb-path">Meu Drive</span>
                </div>

                <div class="tree-wrapper">
                    <ul id="tree-root" class="tree-root">
                    </ul>
                </div>
            </div>
        </main>

        <!-- NOVA COLUNA DIREITA (DETALHES / ATIVIDADE) -->
        <aside class="details-column">
            <section class="preview-panel" id="preview-panel" data-current-id="">
                <h2 class="preview-title" id="preview-main-title">Informa√ß√µes</h2>

                <p id="preview-empty" class="preview-empty">
                    Clique em um arquivo ou pasta para ver informa√ß√µes.
                </p>

                <div id="preview-wrapper" class="hidden">
                    <div class="panel-tabs">
                        <button id="tab-btn-details" class="tab-btn active"
                            onclick="switchTab('details')">Detalhes</button>
                        <button id="tab-btn-activity" class="tab-btn" onclick="switchTab('activity')">Atividade</button>
                    </div>

                    <div id="tab-details" class="tab-content active">
                        <div id="details-content-inner" class="tab-scrollable-area">

                            <div class="preview-meta">
                                <div><span class="label">Tipo:</span> <span id="preview-type"></span></div>
                                <div><span class="label">Tamanho:</span> <span id="preview-size"></span></div>
                                <div><span class="label">Modificado em:</span> <span id="preview-modified"></span></div>
                            </div>

                            <div id="preview-thumbnail-wrapper" class="preview-thumbnail-wrapper hidden">
                                <img id="preview-thumbnail" alt="Miniatura do arquivo" referrerpolicy="no-referrer">
                            </div>

                            <a id="preview-open-link" href="#" target="_blank" class="btn-link disabled"
                                rel="noopener noreferrer">
                                Abrir no Google Drive
                            </a>
                        </div>

                        <div id="details-folder-message" class="preview-empty-state hidden">
                            Detalhes t√©cnicos simplificados para pastas.
                        </div>
                    </div>

                    <div id="tab-activity" class="tab-content">
                        <div id="activity-loading" class="preview-empty-state hidden">Carregando atividade...</div>

                        <ul id="activity-list" class="activity-list tab-scrollable-area">
                        </ul>
                    </div>
                </div>
            </section>
        </aside>

    </div>

    <div id="progress-container" class="progress-container progress-floating hidden">
        <div class="progress-header">
            <span id="progress-phase">Processando...</span>
            <span id="progress-percent">0%</span>
        </div>
        <div class="progress-bar-bg">
            <div id="progress-bar" class="progress-bar-fill"></div>
        </div>
        <p id="progress-text" class="progress-text"></p>

        <div class="progress-controls" style="display:flex; gap:5px; justify-content:center; margin-top:8px;">
            <button id="btn-pause-fg" type="button" class="btn-ghost btn-xs" onclick="togglePauseForeground()">‚è∏
                Pausar</button>
            <button type="button" class="btn-danger btn-xs" onclick="cancelTask()">‚èπ Cancelar</button>
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop hidden">
        <div class="modal">
            <h2 id="modal-title">Baixar</h2>
            <p class="subtitle" id="modal-subtitle"></p>

            <form id="download-form" onsubmit="return false;">
                <input type="hidden" name="items_json" id="items_json">
                <input type="hidden" name="task_id" id="task_id">

                <div class="modal-grid">
                    <div class="form-section modal-section-wide">
                        <div class="form-section-title">Configura√ß√µes Gerais</div>

                        <div class="form-group">
                            <label for="zip_name">Nome do Arquivo</label>
                            <div style="display:flex; gap:8px;" class="suggestion-wrapper">
                                <input type="text" id="zip_name" name="zip_name" placeholder="Ex: backup_drive"
                                    style="flex:1;">
                                <button type="button" class="btn-ghost btn-xs" onclick="toggleSuggestionMenu()">
                                    Sugest√£o ‚ñº
                                </button>
                                <div id="suggestion-menu" class="suggestion-menu">
                                    <div class="suggestion-item" onclick="applySuggestion('date')">Nome + Data (Padr√£o)
                                    </div>
                                    <div class="suggestion-item" onclick="applySuggestion('clean')">Apenas Nome da Pasta
                                    </div>
                                    <div class="suggestion-item" onclick="applySuggestion('random')">Aleat√≥rio / Hash
                                    </div>
                                </div>
                            </div>
                            <small>A extens√£o ser√° adicionada automaticamente.</small>
                        </div>

                        <div class="form-group box-highlight">
                            <label style="margin-bottom:8px; display:block; font-weight:600;">Como deseja
                                processar?</label>
                            <div class="radio-group-vertical">
                                <label class="radio-option">
                                    <input type="radio" name="execution_mode" value="immediate" checked>
                                    <div>
                                        <strong>Baixar Agora</strong>
                                        <span>Aguarda o processamento e inicia o download automaticamente ao
                                            final.</span>
                                    </div>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="execution_mode" value="background">
                                    <div>
                                        <strong>Segundo Plano</strong>
                                        <span>O servidor processa e salva na aba "Meus Backups". Voc√™ pode fechar esta
                                            janela.</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="output_mode">Formato de Sa√≠da</label>
                            <select id="output_mode" name="output_mode">
                                <option value="archive" selected>Arquivo Compactado (ZIP/Tar)</option>
                                <option value="mirror">Espelho Local (Sync)</option>
                            </select>
                        </div>

                        <div class="form-group archive-only">
                            <label for="archive_format">Formato</label>
                            <select id="archive_format" name="archive_format">
                                <option value="zip">ZIP (.zip)</option>
                                <option value="tar.gz">Tar GZip (.tar.gz)</option>
                            </select>
                        </div>

                        <div class="form-group archive-only">
                            <label for="compression_level">Compress√£o</label>
                            <select id="compression_level" name="compression_level">
                                <option value="fast">R√°pida (Menor)</option>
                                <option value="normal" selected>Normal</option>
                                <option value="max">M√°xima (Mais lento)</option>
                            </select>
                        </div>

                        <div class="form-group mirror-only" style="display:none;">
                            <label for="local_mirror_path">Pasta Local (Servidor)</label>
                            <input type="text" id="local_mirror_path" name="local_mirror_path"
                                placeholder="/home/user/Backups/ClienteA">
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Filtros de Arquivo</div>

                        <div class="form-group">
                            <label>Tipos a incluir</label>
                            <div class="filter-types">
                                <label><input type="checkbox" name="type_pdf" value="1" checked> PDF</label>
                                <label><input type="checkbox" name="type_docs" value="1" checked> Docs</label>
                                <label><input type="checkbox" name="type_sheets" value="1" checked> Planilhas</label>
                                <label><input type="checkbox" name="type_images" value="1" checked> Imagens</label>
                                <label><input type="checkbox" name="type_videos" value="1" checked> V√≠deos</label>
                                <label><input type="checkbox" name="type_others" value="1" checked> Outros</label>
                            </div>
                        </div>

                        <div class="form-section-title" style="margin-top: 15px;">Filtros Avan√ßados</div>

                        <div class="form-group">
                            <label>Data</label>
                            <div class="filter-dates">
                                <label>Criado p√≥s: <input type="date" name="created_after"></label>
                                <label>Editado p√≥s: <input type="date" name="modified_after"></label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="max_size_mb">Tam. M√°x (MB)</label>
                            <input type="number" id="max_size_mb" name="max_size_mb"
                                placeholder="Ignorar maiores que...">
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Salvar como modelo</div>

                        <div class="form-group">
                            <label for="profile_name">Nome do modelo</label>
                            <input type="text" id="profile_name" name="profile_name"
                                placeholder="Ex: Backup mensal Cliente A">
                        </div>

                        <div class="form-group">
                            <label for="zip_pattern">Padr√£o do nome do arquivo (opcional)</label>
                            <input type="text" id="zip_pattern" name="zip_pattern" placeholder="Ex: backup-{YYYYMMDD}">
                            <div class="form-hint">
                                Voc√™ pode usar {YYYYMMDD}, {YYYY}, {YY}, {MM}, {DD} para datas.
                            </div>
                        </div>

                        <div id="profile-save-feedback" class="form-hint"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div>
                        <button type="button" class="btn-ghost" onclick="closeModal()">Cancelar</button>
                        <button type="button" class="btn-ghost" onclick="saveCurrentAsProfile()">
                            Salvar Modelo
                        </button>
                    </div>
                    <button type="button" class="btn-primary" onclick="startDownloadProcess()">
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =========================================================
        // VARI√ÅVEIS GLOBAIS
        // =========================================================
        let currentTaskId = null;
        let progressTimer = null;
        let activeTasksTimer = null;
        let includeFiles = false;
        let selectedItems = [];   // Array de objetos {id, name, type}
        let selectedNodeIds = new Set(); // Set de strings "type:id" para lookup r√°pido
        let favorites = [];
        let backupProfiles = [];
        let lastLogCount = 0;
        let isPausedForeground = false;

        // CACHE DE METADADOS EM MEM√ìRIA
        const itemCache = new Map();

        // =========================================================
        // UTILIT√ÅRIOS
        // =========================================================

        function humanSize(bytes) {
            if (bytes === undefined || bytes === null || isNaN(bytes)) return '‚Äî';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            let v = parseInt(bytes);
            while (v >= 1024 && i < units.length - 1) {
                v /= 1024;
                i++;
            }
            return (i === 0 ? v.toFixed(0) : v.toFixed(1)) + ' ' + units[i];
        }

        function computeBreadcrumb(li) {
            const parts = [];
            let node = li;
            while (node) {
                const name = node.dataset.name ||
                    (node.querySelector(':scope > .tree-row .tree-name')?.textContent || '').trim();
                if (name) parts.unshift(name);
                node = node.parentElement.closest('.tree-node');
            }
            return parts.join(' / ');
        }

        function updateBreadcrumbFromNode(li) {
            const pathSpan = document.getElementById('breadcrumb-path');
            if (!pathSpan || !li) return;
            const crumb = computeBreadcrumb(li);
            pathSpan.textContent = crumb || 'Meu Drive';
        }

        // =========================================================
        // L√ìGICA DE ABAS (TABS)
        // =========================================================

        function switchTab(tabName) {
            // Remove active de todos
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Adiciona active no selecionado
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // =========================================================
        // L√ìGICA DE CACHE
        // =========================================================

        function updateItemCache(items, parentId) {
            let totalBytes = 0;
            let hasFiles = false;

            items.forEach(item => {
                // Guarda metadados completos no cache
                itemCache.set(item.id, item);

                // Soma tamanhos para estimativa da pasta pai
                if (item.size) {
                    totalBytes += parseInt(item.size);
                    hasFiles = true;
                }
            });

            // Se temos um pai conhecido no cache, atualizamos a estimativa dele
            if (parentId && itemCache.has(parentId)) {
                const parent = itemCache.get(parentId);
                parent.estimatedSize = totalBytes;
                parent.hasCalculatedSize = true;
                itemCache.set(parentId, parent);

                // Se o painel de detalhes estiver mostrando este pai agora, atualiza a view
                const currentPreviewId = document.getElementById('preview-panel').dataset.currentId;
                if (currentPreviewId === parentId) {
                    showItemPreview(parent, null); // null pois n√£o precisamos do li para refresh
                }
            }
        }

        // =========================================================
        // PAINEL DE TAREFAS
        // =========================================================
        function toggleTaskPanel() {
            const panel = document.getElementById('task-manager-panel');
            panel.classList.toggle('show');
            document.getElementById('log-panel').classList.add('hidden');
        }

        // =========================================================
        // PAINEL DE LOGS
        // =========================================================
        function toggleLogPanel() {
            const panel = document.getElementById('log-panel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                document.getElementById('task-manager-panel').classList.remove('show');
                const badge = document.getElementById('notification-badge');
                badge.classList.add('hidden');
                badge.innerText = '0';
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateLogPanel(history) {
            if (!history || !Array.isArray(history)) return;

            const listEl = document.getElementById('log-list');
            const badge = document.getElementById('notification-badge');

            if (history.length > lastLogCount) {
                const diff = history.length - lastLogCount;
                if (document.getElementById('log-panel').classList.contains('hidden')) {
                    badge.innerText = diff > 99 ? '99+' : diff;
                    badge.classList.remove('hidden');
                }
            }
            lastLogCount = history.length;

            if (history.length === 0) {
                listEl.innerHTML = '<li class="log-empty">Nenhuma atividade recente.</li>';
                return;
            }

            const recent = history.slice().reverse().slice(0, 50);
            let html = '';
            recent.forEach(msg => {
                let icon = '‚Ä¢';
                if (msg.includes('Mapeado')) icon = 'üîç';
                else if (msg.includes('Baixado')) icon = '‚¨áÔ∏è';
                else if (msg.includes('Compactando')) icon = 'üì¶';
                else if (msg.includes('ERRO')) icon = '‚ùå';
                else if (msg.includes('PAUSADO')) icon = '‚è∏';
                else if (msg.includes('CANCELADO')) icon = '‚õî';
                else if (msg.includes('conclu√≠do')) icon = '‚úÖ';

                html += `
                    <li class="log-item">
                        <div class="log-icon">${icon}</div>
                        <div>${msg}</div>
                    </li>
                `;
            });
            listEl.innerHTML = html;
        }

        // =========================================================
        // SUGEST√ÉO DE NOME
        // =========================================================
        function toggleSuggestionMenu() {
            const menu = document.getElementById('suggestion-menu');
            menu.classList.toggle('show');
        }

        function applySuggestion(type) {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
            let base = "backup";
            if (selectedItems.length > 0) base = selectedItems[0].name.replace(/[^\w\s-]/gi, '_');

            let finalName = "";
            if (type === 'date') finalName = `${base}_${dateStr}`;
            else if (type === 'clean') finalName = base;
            else if (type === 'random') finalName = `${base}_${Math.random().toString(36).substring(7)}`;

            document.getElementById('zip_name').value = finalName;
            document.getElementById('suggestion-menu').classList.remove('show');
        }

        // =========================================================
        // FAVORITOS
        // =========================================================

        function loadFavorites() {
            fetch('/api/favorites')
                .then(r => r.json())
                .then(data => {
                    favorites = data.favorites || [];
                    renderFavorites();
                    favorites.forEach(fav => {
                        const node = document.querySelector(`.tree-node[data-id="${fav.id}"]`);
                        if (node) {
                            const btn = node.querySelector('.fav-btn');
                            if (btn) btn.classList.add('fav-on');
                        }
                    });
                })
                .catch(err => {
                    console.error("Erro ao carregar favoritos:", err);
                    document.getElementById('favorites-list').textContent = 'Erro ao carregar.';
                });
        }

        function isFavorite(id) {
            return favorites.some(f => f.id === id);
        }

        function renderFavorites() {
            const box = document.getElementById('favorites-list');
            if (!box) return;
            box.innerHTML = '';

            if (!favorites.length) {
                box.textContent = 'Nenhum favorito salvo.';
                return;
            }

            favorites.forEach(fav => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'favorite-item';
                btn.textContent = '‚≠ê ' + fav.name;
                btn.title = fav.path || fav.name;
                btn.addEventListener('click', () => {
                    focusNodeById(fav.id);
                });
                box.appendChild(btn);
            });
        }

        function toggleFavorite(item, li, favBtn) {
            const path = computeBreadcrumb(li);
            if (isFavorite(item.id)) {
                fetch('/api/favorites/' + encodeURIComponent(item.id), { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            favorites = favorites.filter(f => f.id !== item.id);
                            favBtn.classList.remove('fav-on');
                            renderFavorites();
                        } else {
                            alert("Erro ao remover favorito.");
                        }
                    })
                    .catch(console.error);
            } else {
                const payload = {
                    id: item.id,
                    name: item.name,
                    path: path,
                    type: item.type
                };

                fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            const exists = favorites.find(f => f.id === item.id);
                            if (!exists) favorites.push(payload);
                            favBtn.classList.add('fav-on');
                            renderFavorites();
                        } else {
                            alert("Erro ao salvar favorito.");
                        }
                    })
                    .catch(console.error);
            }
        }

        // -------------------------------------------------------------
        // NAVEGA√á√ÉO PROFUNDA (DEEP LINKING)
        // -------------------------------------------------------------
        async function focusNodeById(targetId) {
            let node = document.querySelector(`.tree-node[data-id="${targetId}"]`);
            if (node) {
                revealNode(node);
                // For√ßa update do preview ao focar via favorito
                const item = {
                    id: node.dataset.id,
                    name: node.dataset.name,
                    type: node.dataset.type
                };
                showItemPreview(item, node);
                return;
            }

            const originalTitle = document.title;
            document.title = "Localizando pasta...";
            document.body.style.cursor = 'wait';

            try {
                const resp = await fetch(`/api/path/${targetId}`);
                const data = await resp.json();

                if (!data.path || !Array.isArray(data.path)) {
                    alert("N√£o foi poss√≠vel localizar o caminho desta pasta.");
                    return;
                }

                const pathIds = data.path;

                for (const id of pathIds) {
                    let currentNode = document.querySelector(`.tree-node[data-id="${id}"]`);
                    if (currentNode) {
                        if (id !== targetId) {
                            await ensureNodeExpanded(currentNode);
                        }
                    } else {
                        console.warn(`N√≥ intermedi√°rio ${id} n√£o encontrado na √°rvore.`);
                    }
                }

                node = document.querySelector(`.tree-node[data-id="${targetId}"]`);
                if (node) {
                    revealNode(node);
                    const item = {
                        id: node.dataset.id,
                        name: node.dataset.name,
                        type: node.dataset.type
                    };
                    showItemPreview(item, node);
                } else {
                    alert("Pasta n√£o encontrada ap√≥s expans√£o.");
                }

            } catch (err) {
                console.error(err);
                alert("Erro ao buscar caminho da pasta.");
            } finally {
                document.body.style.cursor = 'default';
                document.title = originalTitle;
            }
        }

        function ensureNodeExpanded(node) {
            return new Promise((resolve) => {
                if (!node.classList.contains('collapsed')) {
                    resolve();
                    return;
                }
                const toggle = node.querySelector(':scope > .tree-row .tree-toggle');
                if (toggle) {
                    if (node.dataset.loaded === 'true') {
                        toggle.click();
                        resolve();
                    } else {
                        const parentId = node.dataset.id;
                        const childrenUl = node.querySelector(':scope > .tree-children');
                        node.classList.remove('collapsed');
                        childrenUl.style.display = 'block';
                        toggle.textContent = '‚ñæ';
                        loadChildren(parentId, childrenUl, node, toggle).then(() => {
                            resolve();
                        });
                    }
                } else {
                    resolve();
                }
            });
        }

        function revealNode(node) {
            let current = node.parentElement.closest('.tree-node');
            while (current) {
                const toggle = current.querySelector(':scope > .tree-row .tree-toggle');
                if (toggle && current.classList.contains('collapsed')) {
                    current.classList.remove('collapsed');
                    const ul = current.querySelector(':scope > .tree-children');
                    if (ul) ul.style.display = 'block';
                    toggle.textContent = '‚ñæ';
                }
                current = current.parentElement.closest('.tree-node');
            }

            setTimeout(() => {
                node.scrollIntoView({ behavior: 'smooth', block: 'center' });
                node.classList.add('tree-node-highlight');
                setTimeout(() => node.classList.remove('tree-node-highlight'), 2000);
            }, 100);
        }

        // =========================================================
        // PERFIS DE BACKUP
        // =========================================================
        function applyZipPattern(pattern) {
            if (!pattern) pattern = "backup-{YYYYMMDD}";
            const now = new Date();
            const yyyy = now.getFullYear();
            const yy = String(yyyy).slice(-2);
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');

            let name = pattern;
            name = name.replace(/\{YYYYMMDD\}/g, `${yyyy}${mm}${dd}`);
            name = name.replace(/\{YYYYMM\}/g, `${yyyy}${mm}`);
            name = name.replace(/\{YYYY\}/g, String(yyyy));
            name = name.replace(/\{YY\}/g, yy);
            name = name.replace(/\{MM\}/g, mm);
            name = name.replace(/\{DD\}/g, dd);
            name = name.replace(/[\\/:*?"<>|]/g, "_");
            return name;
        }

        function loadProfiles() {
            fetch('/api/profiles')
                .then(resp => resp.json())
                .then(data => {
                    backupProfiles = data.profiles || [];
                    renderProfiles();
                })
                .catch(err => {
                    console.error('Erro ao carregar perfis:', err);
                    const box = document.getElementById('profiles-list');
                    if (box) box.textContent = 'Erro ao carregar.';
                });
        }

        function renderProfiles() {
            const box = document.getElementById('profiles-list');
            if (!box) return;
            box.innerHTML = '';

            if (!backupProfiles.length) {
                box.textContent = 'Nenhum perfil salvo.';
                return;
            }

            backupProfiles.forEach(profile => {
                const wrapper = document.createElement('div');
                wrapper.className = 'profile-item';

                const title = document.createElement('div');
                title.className = 'profile-title';
                title.textContent = profile.name || '(sem nome)';

                const subtitle = document.createElement('div');
                subtitle.className = 'profile-subtitle';
                const pattern = profile.zip_pattern || '';
                const displayName = profile.zip_name
                    || (pattern ? applyZipPattern(pattern) : 'backup');
                subtitle.textContent = `Arquivo: ${displayName}`;

                if (profile.items && profile.items.length > 0) {
                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'profile-items-preview';
                    const header = document.createElement('div');
                    header.className = 'profile-items-title';
                    header.textContent = `Itens (${profile.items.length})`;
                    itemsContainer.appendChild(header);

                    profile.items.forEach(it => {
                        const row = document.createElement('div');
                        row.className = 'profile-item-row';
                        const icon = it.type === 'folder' ? 'üìÅ' : 'üìÑ';
                        row.innerHTML = `<span style="font-size:10px;">${icon}</span> <span>${it.name}</span>`;
                        itemsContainer.appendChild(row);
                    });
                    wrapper.appendChild(itemsContainer);
                }

                const actions = document.createElement('div');
                actions.className = 'profile-actions';

                const runButton = document.createElement('button');
                runButton.className = 'btn-primary btn-xs';
                runButton.textContent = 'Rodar';
                runButton.addEventListener('click', () => {
                    runBackupProfile(profile.id, true);
                });

                const detailsButton = document.createElement('button');
                detailsButton.className = 'btn-ghost btn-xs';
                detailsButton.textContent = 'Detalhes';
                detailsButton.addEventListener('click', () => {
                    openProfileDetails(profile.id);
                });

                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn-ghost btn-xs';
                deleteButton.textContent = 'Excluir';
                deleteButton.addEventListener('click', () => {
                    if (confirm(`Remover "${profile.name}"?`)) deleteProfile(profile.id);
                });

                actions.appendChild(runButton);
                actions.appendChild(detailsButton);
                actions.appendChild(deleteButton);

                wrapper.appendChild(title);
                wrapper.appendChild(subtitle);
                wrapper.appendChild(actions);

                box.appendChild(wrapper);
            });
        }

        function deleteProfile(id) {
            fetch('/api/profiles/' + encodeURIComponent(id), { method: 'DELETE' })
                .then(resp => resp.json())
                .then(data => {
                    if (data.ok) {
                        backupProfiles = backupProfiles.filter(p => p.id !== id);
                        renderProfiles();
                    } else {
                        alert("Erro ao excluir.");
                    }
                });
        }

        function collectCurrentFiltersFromForm() {
            const groups = [];
            if (document.querySelector('input[name="type_pdf"]')?.checked) groups.push('pdf');
            if (document.querySelector('input[name="type_docs"]')?.checked) groups.push('docs');
            if (document.querySelector('input[name="type_sheets"]')?.checked) groups.push('sheets');
            if (document.querySelector('input[name="type_images"]')?.checked) groups.push('images');
            if (document.querySelector('input[name="type_videos"]')?.checked) groups.push('videos');
            if (document.querySelector('input[name="type_others"]')?.checked) groups.push('others');

            const createdAfter = document.querySelector('input[name="created_after"]')?.value || null;
            const modifiedAfter = document.querySelector('input[name="modified_after"]')?.value || null;
            const maxSizeStr = document.getElementById('max_size_mb')?.value || '';
            const outputMode = document.getElementById('output_mode')?.value || 'archive';
            const localPath = document.getElementById('local_mirror_path')?.value || '';
            const archiveFormat = document.getElementById('archive_format')?.value || 'zip';
            const compressionLevel = document.getElementById('compression_level')?.value || 'normal';
            const execRadio = document.querySelector('input[name="execution_mode"]:checked');
            const executionMode = execRadio ? execRadio.value : 'immediate';

            let maxSizeMb = null;
            if (maxSizeStr) {
                const parsed = parseInt(maxSizeStr, 10);
                if (!Number.isNaN(parsed)) maxSizeMb = parsed;
            }

            return {
                groups,
                created_after: createdAfter,
                modified_after: modifiedAfter,
                max_size_mb: maxSizeMb,
                output_mode: outputMode,
                local_mirror_path: localPath,
                archive_format: archiveFormat,
                compression_level: compressionLevel,
                execution_mode: executionMode,
            };
        }

        function saveCurrentAsProfile() {
            const feedbackEl = document.getElementById('profile-save-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = '';
                feedbackEl.className = 'form-hint';
            }

            if (!selectedItems.length) {
                if (feedbackEl) {
                    feedbackEl.textContent = 'Selecione pelo menos um item para salvar como modelo.';
                    feedbackEl.className = 'form-error';
                }
                return;
            }

            const nameInput = document.getElementById('profile_name');
            const name = (nameInput?.value || '').trim();
            if (!name) {
                if (feedbackEl) {
                    feedbackEl.textContent = 'Informe um nome para o modelo.';
                    feedbackEl.className = 'form-error';
                }
                if (nameInput) nameInput.focus();
                return;
            }

            const zipName = (document.getElementById('zip_name')?.value || '').trim() || 'backup';
            const zipPatternInput = document.getElementById('zip_pattern');
            let zipPattern = (zipPatternInput?.value || '').trim();

            if (!zipPattern) {
                zipPattern = zipName;
            }

            const filters = collectCurrentFiltersFromForm();
            const payload = {
                name: name,
                zip_name: zipName,
                zip_pattern: zipPattern,
                items: selectedItems,
                ...filters
            };

            fetch('/api/profiles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        loadProfiles();
                        if (feedbackEl) {
                            feedbackEl.textContent = 'Modelo salvo com sucesso.';
                            feedbackEl.className = 'form-success';
                        }
                    } else {
                        if (feedbackEl) {
                            feedbackEl.textContent = 'Erro ao salvar: ' + (data.error || 'Desconhecido');
                            feedbackEl.className = 'form-error';
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    if (feedbackEl) {
                        feedbackEl.textContent = 'Erro de conex√£o ao salvar modelo.';
                        feedbackEl.className = 'form-error';
                    }
                });
        }

        function applyFiltersToFormFromProfile(profile) {
            const allTypes = ['pdf', 'docs', 'sheets', 'images', 'videos', 'others'];
            const groups = profile.groups || [];
            allTypes.forEach(g => {
                const el = document.querySelector(`input[name="type_${g}"]`);
                if (el) el.checked = !groups.length || groups.includes(g);
            });

            if (profile.created_after) document.querySelector('input[name="created_after"]').value = profile.created_after;
            if (profile.modified_after) document.querySelector('input[name="modified_after"]').value = profile.modified_after;
            if (profile.max_size_mb) document.getElementById('max_size_mb').value = profile.max_size_mb;

            if (profile.output_mode) document.getElementById('output_mode').value = profile.output_mode;
            if (profile.local_mirror_path) document.getElementById('local_mirror_path').value = profile.local_mirror_path;
            if (profile.archive_format) document.getElementById('archive_format').value = profile.archive_format;
            if (profile.compression_level) document.getElementById('compression_level').value = profile.compression_level;

            updateOutputModeUI();
        }

        function runBackupProfile(profileId, autoRun) {
            const profile = backupProfiles.find(p => p.id === profileId);
            if (!profile) return;

            selectedItems = profile.items || [];
            selectedNodeIds = new Set();
            selectedItems.forEach(it => selectedNodeIds.add(`${it.type}:${it.id}`));
            updateSelectionInfo();

            document.getElementById('items_json').value = JSON.stringify(selectedItems);

            const pat = profile.zip_pattern || 'backup-{YYYYMMDD}';
            const zipInput = document.getElementById('zip_name');
            const patternInput = document.getElementById('zip_pattern');
            const profileNameInput = document.getElementById('profile_name');

            if (zipInput) zipInput.value = profile.zip_name || applyZipPattern(pat);
            if (patternInput) patternInput.value = pat || '';
            if (profileNameInput) profileNameInput.value = profile.name || '';

            applyFiltersToFormFromProfile(profile);

            const execMode = profile.execution_mode || 'immediate';
            const radio = document.querySelector(`input[name="execution_mode"][value="${execMode}"]`);
            if (radio) radio.checked = true;

            if (autoRun) {
                startDownloadProcess();
            } else {
                openModalForSelected();
            }
        }

        function openProfileDetails(profileId) {
            const profile = backupProfiles.find(p => p.id === profileId);
            if (!profile) return;

            selectedItems = profile.items || [];
            selectedNodeIds = new Set();
            selectedItems.forEach(it => selectedNodeIds.add(`${it.type}:${it.id}`));
            updateSelectionInfo();

            document.getElementById('items_json').value = JSON.stringify(selectedItems);

            const pat = profile.zip_pattern || 'backup-{YYYYMMDD}';
            const zipInput = document.getElementById('zip_name');
            const patternInput = document.getElementById('zip_pattern');
            const profileNameInput = document.getElementById('profile_name');
            const feedbackEl = document.getElementById('profile-save-feedback');

            if (zipInput) zipInput.value = profile.zip_name || applyZipPattern(pat);
            if (patternInput) patternInput.value = pat || '';
            if (profileNameInput) profileNameInput.value = profile.name || '';
            if (feedbackEl) {
                feedbackEl.textContent = '';
                feedbackEl.className = 'form-hint';
            }

            applyFiltersToFormFromProfile(profile);

            const execMode = profile.execution_mode || 'immediate';
            const radio = document.querySelector(`input[name="execution_mode"][value="${execMode}"]`);
            if (radio) radio.checked = true;

            document.getElementById('modal-title').innerText = `Modelo: ${profile.name || ''}`;
            document.getElementById('modal-subtitle').innerText =
                `${selectedItems.length} item(ns) configurado(s) neste modelo.`;

            updateOutputModeUI();
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        // =========================================================
        // UI & DOWNLOAD (MODAL + AJAX)
        // =========================================================

        function updateOutputModeUI() {
            const mode = document.getElementById('output_mode').value;
            const archiveFields = document.querySelectorAll('.archive-only');
            const mirrorFields = document.querySelectorAll('.mirror-only');
            archiveFields.forEach(el => el.style.display = mode === 'archive' ? 'block' : 'none');
            mirrorFields.forEach(el => el.style.display = mode === 'mirror' ? 'block' : 'none');
        }

        function openModalForSelected() {
            if (!selectedItems.length) {
                alert("Selecione pelo menos um item.");
                return;
            }
            document.getElementById('download-form').reset();
            document.getElementById('profile-save-feedback').innerText = '';
            document.getElementById('modal-title').innerText = "Baixar";
            document.getElementById('items_json').value = JSON.stringify(selectedItems);
            const subEl = document.getElementById('modal-subtitle');
            subEl.innerText = `${selectedItems.length} item(ns) selecionado(s).`;
            applySuggestion('date');
            updateOutputModeUI();
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('suggestion-menu').classList.remove('show');
        }

        function startDownloadProcess() {
            const form = document.getElementById('download-form');
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());

            ['type_pdf', 'type_docs', 'type_sheets', 'type_images', 'type_videos', 'type_others'].forEach(k => {
                const el = form.querySelector(`input[name="${k}"]`);
                if (el && el.checked) payload[k] = "1";
                else delete payload[k];
            });

            closeModal();
            const executionMode = payload.execution_mode || 'immediate';

            if (executionMode === 'background') {
                alert("Tarefa iniciada em segundo plano! Acompanhe no widget inferior direito.");
            } else {
                showProgressUI();
            }

            fetch('/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        if (executionMode === 'immediate') {
                            currentTaskId = data.task_id;
                            startPollingForeground();
                        } else {
                            pollActiveTasks();
                        }
                    } else {
                        alert("Erro ao iniciar: " + data.error);
                        hideProgressUI();
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro de conex√£o.");
                    hideProgressUI();
                });
        }

        // --- PROGRESSO FOREGROUND ---
        function showProgressUI() {
            const c = document.getElementById('progress-container');
            c.classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-bar').classList.remove('error');
            document.getElementById('progress-percent').innerText = '0%';
            document.getElementById('progress-phase').innerText = 'INICIANDO';
            document.getElementById('progress-text').innerText = 'Conectando...';
            document.getElementById('btn-pause-fg').innerText = "‚è∏ Pausar";
            isPausedForeground = false;
            lastLogCount = 0;
            document.getElementById('log-list').innerHTML = '<li class="log-empty">Iniciando...</li>';
        }

        function hideProgressUI() {
            document.getElementById('progress-container').classList.add('hidden');
        }

        function startPollingForeground() {
            if (progressTimer) clearInterval(progressTimer);
            progressTimer = setInterval(() => {
                if (!currentTaskId) return;
                fetch('/progress/' + currentTaskId)
                    .then(r => r.json())
                    .then(data => {
                        updateProgressBar(data);
                        if (data.history) updateLogPanel(data.history);

                        if (data.phase === 'concluido') {
                            clearInterval(progressTimer);
                            document.getElementById('progress-phase').innerText = "CONCLU√çDO";
                            if (data.download_url) {
                                document.getElementById('progress-text').innerText = "Baixando arquivo...";
                                window.location.href = data.download_url;
                                setTimeout(hideProgressUI, 3000);
                            } else {
                                document.getElementById('progress-text').innerText = "Finalizado.";
                            }
                        } else if (data.phase === 'erro' || data.phase === 'cancelado') {
                            clearInterval(progressTimer);
                            document.getElementById('progress-bar').classList.add('error');
                            document.getElementById('progress-text').innerText = data.message;
                        }
                    })
                    .catch(console.error);
            }, 1000);
        }

        function updateProgressBar(data) {
            let percent = 0;
            const phase = data.phase || 'processando';
            if (phase === 'mapeando') {
                const f = data.files_found || 0;
                percent = Math.min(20, f * 0.1);
            } else if (phase === 'baixando') {
                if (data.files_total > 0) {
                    percent = 20 + ((data.files_downloaded / data.files_total) * 70);
                } else {
                    percent = 30;
                }
            } else if (phase === 'compactando') {
                percent = 90;
            } else if (phase === 'concluido') {
                percent = 100;
            }
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = Math.round(percent) + '%';
            document.getElementById('progress-phase').innerText = phase.toUpperCase();
            if (phase !== 'concluido') {
                document.getElementById('progress-text').innerText = data.message || '';
            }
        }

        function togglePauseForeground() {
            if (!currentTaskId) return;
            const url = isPausedForeground ? `/api/tasks/resume/${currentTaskId}` : `/api/tasks/pause/${currentTaskId}`;
            fetch(url, { method: 'POST' }).then(r => r.json()).then(d => {
                if (d.ok) {
                    isPausedForeground = !isPausedForeground;
                    document.getElementById('btn-pause-fg').innerText = isPausedForeground ? "‚ñ∂ Continuar" : "‚è∏ Pausar";
                }
            });
        }

        function cancelTask() {
            if (!currentTaskId) return;
            if (!confirm("Cancelar tarefa?")) return;
            fetch('/cancel/' + currentTaskId, { method: 'POST' })
                .then(r => r.json())
                .then(() => {
                    document.getElementById('progress-text').innerText = "Cancelando...";
                });
        }

        // =========================================================
        // GERENCIADOR DE TAREFAS (BACKGROUND/GLOBAL)
        // =========================================================
        function startActiveTasksPoller() {
            if (activeTasksTimer) clearInterval(activeTasksTimer);
            activeTasksTimer = setInterval(pollActiveTasks, 500);
            pollActiveTasks();
        }

        function pollActiveTasks() {
            fetch('/api/tasks/active').then(r => r.json()).then(data => {
                const tasks = data.tasks || [];
                const list = document.getElementById('task-manager-list');
                const badge = document.getElementById('task-badge');

                if (tasks.length > 0) {
                    badge.innerText = tasks.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.innerText = '0';
                    badge.classList.add('hidden');
                }

                if (!currentTaskId && tasks.length > 0) {
                    const activeId = tasks[0].id;
                    fetch('/progress/' + activeId)
                        .then(r => r.json())
                        .then(d => {
                            if (d.history) updateLogPanel(d.history);
                        })
                        .catch(console.error);
                }

                if (tasks.length === 0) {
                    list.innerHTML = '<div class="task-empty-state">Nenhuma tarefa ativa no momento.</div>';
                    return;
                }

                list.innerHTML = tasks.map(t => {
                    // L√ìGICA DE EXIBI√á√ÉO DO CONTADOR NO T√çTULO
                    let phaseDisplay = t.phase.toUpperCase();
                    let isMapping = false;

                    if (t.phase === 'mapeando') {
                        isMapping = true;
                        // Se estiver mapeando, mostra a contagem
                        if (t.files_found && t.files_found > 0) {
                            phaseDisplay = `MAPEANDO (${t.files_found})`;
                        }
                    }

                    // Classe especial para barra de progresso durante o mapeamento
                    let progressClass = '';
                    if (isMapping) progressClass = 'mapping';
                    else if (t.paused) progressClass = 'paused';

                    return `
                    <div class="task-item">
                        <div class="task-info">
                            <span>${phaseDisplay}</span>
                            <span style="font-weight:normal; font-size:11px; color:#999;">${t.id.split('-').pop()}</span>
                        </div>
                        <div class="task-meta">${t.message}</div>
                        <div class="task-progress-bg">
                            <div class="task-progress-fill ${progressClass}" style="width: ${t.percent}%"></div>
                        </div>
                        <div class="task-controls">
                            ${!t.paused ?
                            `<button class="btn-mini pause" onclick="apiTaskAction('${t.id}', 'pause')">PAUSAR</button>` :
                            `<button class="btn-mini resume" onclick="apiTaskAction('${t.id}', 'resume')">RESUMIR</button>`
                        }
                            <button class="btn-mini cancel" onclick="apiTaskAction('${t.id}', 'cancel')">CANCELAR</button>
                        </div>
                    </div>
                `}).join('');
            });
        }

        window.apiTaskAction = function (tid, action) {
            let url = '';
            if (action === 'pause') url = `/api/tasks/pause/${tid}`;
            if (action === 'resume') url = `/api/tasks/resume/${tid}`;
            if (action === 'cancel') url = `/cancel/${tid}`;

            fetch(url, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    pollActiveTasks();
                });
        }


        // =========================================================
        // TREE VIEW (√ÅRVORE DE PASTAS)
        // =========================================================

        function createFolderNode(folder) {
            const li = document.createElement('li');
            li.className = 'tree-node collapsed';
            li.dataset.id = folder.id;
            li.dataset.name = folder.name;
            li.dataset.type = 'folder';

            const row = document.createElement('div');
            row.className = 'tree-row';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'tree-toggle';
            toggleBtn.textContent = '‚ñ∏';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-checkbox';

            const favBtn = document.createElement('button');
            favBtn.className = 'fav-btn';
            favBtn.textContent = '‚òÜ';

            const icon = document.createElement('span');
            icon.className = 'tree-folder-icon';
            icon.textContent = 'üìÅ';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'tree-name';
            nameSpan.textContent = folder.name;

            row.append(toggleBtn, checkbox, favBtn, icon, nameSpan);

            const childrenUl = document.createElement('ul');
            childrenUl.className = 'tree-children';
            childrenUl.style.display = 'none';

            li.append(row, childrenUl);

            // Item reference
            const item = { id: folder.id, name: folder.name, type: 'folder' };
            if (isFavorite(item.id)) favBtn.classList.add('fav-on');

            // --- EVENTOS ---

            favBtn.onclick = (e) => {
                e.stopPropagation();
                toggleFavorite(item, li, favBtn);
            };

            checkbox.onchange = (e) => {
                e.stopPropagation();
                handleCheckboxChange(checkbox, li, item);
                propagateSelectionDown(li, checkbox.checked);
            };

            // Clique na linha mostra PREVIEW (Detalhes/Atividade)
            row.onclick = (e) => {
                // Se clicar nos bot√µes espec√≠ficos, n√£o faz preview
                if ([toggleBtn, checkbox, favBtn].includes(e.target)) return;
                showItemPreview(item, li);
            };

            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                const isCollapsed = li.classList.contains('collapsed');
                if (isCollapsed && !li.dataset.loaded) {
                    loadChildren(folder.id, childrenUl, li, toggleBtn);
                }
                setCollapsedState(li, !isCollapsed);
                toggleBtn.textContent = li.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
            };

            return li;
        }

        function createFileNode(file) {
            const li = document.createElement('li');
            li.className = 'tree-node file-node';
            li.dataset.id = file.id;
            li.dataset.name = file.name;
            li.dataset.type = 'file';

            const row = document.createElement('div');
            row.className = 'tree-row';

            const spacer = document.createElement('span');
            spacer.className = 'tree-spacer';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'select-checkbox';

            const icon = document.createElement('span');
            icon.className = 'tree-folder-icon';
            icon.textContent = 'üìÑ';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'tree-name';
            nameSpan.textContent = file.name;

            row.append(spacer, checkbox, icon, nameSpan);
            li.appendChild(row);

            const item = { id: file.id, name: file.name, type: 'file' };

            checkbox.onchange = (e) => {
                e.stopPropagation();
                handleCheckboxChange(checkbox, li, item);
                propagateSelectionUp(li);
            };

            // MODIFICA√á√ÉO: Renomeado de showFilePreview para showItemPreview
            row.onclick = (e) => {
                if (e.target === checkbox) return;
                showItemPreview(item, li);
            };

            return li;
        }

        function loadChildren(parentId, containerUl, li, toggleBtn) {
            const filesParam = includeFiles ? '1' : '0';
            const url = parentId === 'root'
                ? `/api/folders/root?files=${filesParam}`
                : `/api/folders/children/${encodeURIComponent(parentId)}?files=${filesParam}`;

            containerUl.innerHTML = '<li class="tree-node"><div class="tree-row"><span>Carregando...</span></div></li>';

            return fetch(url)
                .then(r => r.json())
                .then(data => {
                    containerUl.innerHTML = '';
                    const items = data.items || [];

                    // --- Atualizar Cache Global com os itens carregados ---
                    updateItemCache(items, parentId);

                    if (!items.length) {
                        toggleBtn.textContent = '';
                        toggleBtn.classList.add('placeholder');
                        toggleBtn.disabled = true;
                        return;
                    }

                    const parentCheckbox = li.querySelector(':scope > .tree-row .select-checkbox');
                    const parentChecked = parentCheckbox && parentCheckbox.checked && !parentCheckbox.indeterminate;

                    items.forEach(it => {
                        const node = (it.type === 'folder') ? createFolderNode(it) : createFileNode(it);
                        containerUl.appendChild(node);
                        if (parentChecked) setNodeCheckedDeep(node, true);
                    });

                    li.dataset.loaded = 'true';
                })
                .catch(err => {
                    console.error(err);
                    containerUl.innerHTML = '<li class="tree-node">Erro.</li>';
                });
        }

        function setCollapsedState(li, collapsed) {
            const ul = li.querySelector(':scope > .tree-children');
            if (!ul) return;
            if (collapsed) {
                li.classList.add('collapsed');
                ul.style.display = 'none';
            } else {
                li.classList.remove('collapsed');
                ul.style.display = 'block';
            }
        }

        // =========================================================
        // L√ìGICA DE SELE√á√ÉO
        // =========================================================

        function handleCheckboxChange(checkbox, li, item, updateParents = true) {
            const key = `${item.type}:${item.id}`;

            if (checkbox && checkbox.checked) {
                if (!selectedNodeIds.has(key)) {
                    selectedNodeIds.add(key);
                    selectedItems.push(item);
                }
                li.classList.add('tree-node-selected');
                updateBreadcrumbFromNode(li);
            } else {
                if (selectedNodeIds.has(key)) {
                    selectedNodeIds.delete(key);
                    selectedItems = selectedItems.filter(x => !(x.id === item.id && x.type === item.type));
                }
                li.classList.remove('tree-node-selected');
            }

            updateSelectionInfo();
            if (updateParents) propagateSelectionUp(li);
        }

        function updateSelectionInfo() {
            const lbl = document.getElementById('selected-folder-label');
            const cnt = document.getElementById('selection-counter');

            if (!selectedItems.length) {
                if (lbl) lbl.textContent = 'nenhum';
                if (cnt) cnt.textContent = 'Nenhum item selecionado.';
                return;
            }

            const fld = selectedItems.filter(i => i.type === 'folder').length;
            const fls = selectedItems.filter(i => i.type === 'file').length;

            const txt = `${fld} pastas e ${fls} arquivos`;
            if (lbl) lbl.textContent = txt;
            if (cnt) cnt.textContent = txt + ' selecionados.';
        }

        function setNodeCheckedDeep(li, checked) {
            const cb = li.querySelector(':scope > .tree-row .select-checkbox');
            if (cb) {
                cb.checked = checked;
                cb.indeterminate = false;
            }
            const item = {
                id: li.dataset.id,
                name: li.dataset.name,
                type: li.dataset.type
            };
            handleCheckboxChange(cb, li, item, false);
            const children = li.querySelectorAll(':scope > .tree-children > .tree-node');
            children.forEach(c => setNodeCheckedDeep(c, checked));
        }

        function propagateSelectionDown(li, checked) {
            setNodeCheckedDeep(li, checked);
        }

        function propagateSelectionUp(li) {
            const parent = li.parentElement.closest('.tree-node');
            if (!parent) return;
            const childrenCB = parent.querySelectorAll(':scope > .tree-children > .tree-node > .tree-row .select-checkbox');
            const all = Array.from(childrenCB);
            if (!all.length) return;

            const allChecked = all.every(c => c.checked);
            const someChecked = all.some(c => c.checked || c.indeterminate);

            const pCB = parent.querySelector(':scope > .tree-row .select-checkbox');
            if (pCB) {
                pCB.checked = allChecked;
                pCB.indeterminate = !allChecked && someChecked;
                const pItem = { id: parent.dataset.id, name: parent.dataset.name, type: parent.dataset.type };
                handleCheckboxChange(pCB, parent, pItem, false);
            }
            propagateSelectionUp(parent);
        }

        // =========================================================
        // ATIVIDADE (FETCH & RENDER)
        // =========================================================
        function fetchAndRenderActivity(itemId) {
            const listEl = document.getElementById('activity-list');
            const loader = document.getElementById('activity-loading');

            listEl.innerHTML = '';
            loader.classList.remove('hidden');

            fetch(`/api/activity/${itemId}`)
                .then(r => r.json())
                .then(data => {
                    loader.classList.add('hidden');
                    const activities = data.activity || [];

                    if (activities.length === 0) {
                        listEl.innerHTML = '<li class="preview-empty-state">Sem atividade recente.</li>';
                        return;
                    }

                    let html = '';
                    activities.forEach(act => {
                        let icon = 'üìù';
                        if (act.action === 'CRIAR') icon = '‚ú®';
                        if (act.action === 'MOVER') icon = 'üöö';
                        if (act.action === 'EXCLUIR') icon = 'üóëÔ∏è';
                        if (act.action === 'RENOMEAR') icon = 'üè∑Ô∏è';
                        if (act.action === 'EDITAR') icon = '‚úèÔ∏è';

                        html += `
                        <li class="activity-item">
                            <div class="act-icon">${icon}</div>
                            <div class="act-details">
                                <div class="act-action">${act.action}</div>
                                <div class="act-meta">por ${act.actor}</div>
                            </div>
                            <div class="act-date">${act.date}</div>
                        </li>`;
                    });
                    listEl.innerHTML = html;
                })
                .catch(err => {
                    console.error("Erro ao buscar atividade:", err);
                    loader.classList.add('hidden');
                    listEl.innerHTML = '<li class="form-error">Erro ao carregar atividade.</li>';
                });
        }

        // =========================================================
        // PREVIEW E DETALHES (CORRIGIDO E ROBUSTO)
        // =========================================================

        function showItemPreview(item, li) {
            const empty = document.getElementById('preview-empty');
            const wrapper = document.getElementById('preview-wrapper');
            const container = document.getElementById('preview-panel');

            // Define ID atual
            container.dataset.currentId = item.id;

            // 1. Reset Visual Imediato (Limpa dados antigos para n√£o piscar informa√ß√£o errada)
            empty.classList.add('hidden');
            wrapper.classList.remove('hidden');

            // Limpa campos antes de preencher
            document.getElementById('preview-type').textContent = '...';
            document.getElementById('preview-size').textContent = '...';
            document.getElementById('preview-modified').textContent = '...';
            document.getElementById('preview-thumbnail-wrapper').classList.add('hidden');

            const linkBtn = document.getElementById('preview-open-link');
            linkBtn.classList.add('disabled');
            linkBtn.href = '#';

            if (li) updateBreadcrumbFromNode(li);

            // --- L√ìGICA DE DETALHES ---
            const detailsInner = document.getElementById('details-content-inner');
            const detailsMsg = document.getElementById('details-folder-message');

            if (item.type === 'folder') {
                detailsInner.classList.add('hidden');
                detailsMsg.classList.remove('hidden');
            } else {
                detailsInner.classList.remove('hidden');
                detailsMsg.classList.add('hidden');

                // Tenta recuperar do cache
                const cached = itemCache.get(item.id);

                // Verifica se temos dados completos (Size ou Link indicam que j√° foi feita a busca detalhada)
                const hasDeepData = cached && (cached.webViewLink || cached.size !== undefined);

                if (hasDeepData) {
                    renderPreviewData(cached, item.type);
                } else {
                    // Estado de Carregamento Expl√≠cito
                    document.getElementById('preview-type').textContent = "Buscando detalhes...";

                    fetch('/api/file/' + encodeURIComponent(item.id))
                        .then(r => r.json())
                        .then(meta => {
                            // Se der erro na API
                            if (meta.error) {
                                document.getElementById('preview-type').textContent = "Erro ao carregar info";
                                return;
                            }

                            // Mescla os dados novos com o que j√° t√≠nhamos (id, name)
                            const newData = { ...item, ...meta };

                            // Salva no cache
                            itemCache.set(item.id, newData);

                            // S√≥ atualiza a tela se o usu√°rio AINDA estiver com esse item selecionado
                            if (container.dataset.currentId === item.id) {
                                renderPreviewData(newData, item.type);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            if (container.dataset.currentId === item.id) {
                                document.getElementById('preview-type').textContent = "Erro de conex√£o";
                            }
                        });
                }
            }

            // --- L√ìGICA DE ATIVIDADE ---
            fetchAndRenderActivity(item.id);
        }

        function renderPreviewData(meta, type) {
            // 2. Tipo
            const typeEl = document.getElementById('preview-type');
            if (typeEl) {
                if (meta.mimeType === 'application/vnd.google-apps.folder' || type === 'folder') {
                    typeEl.textContent = 'Pasta do Google Drive';
                } else {
                    typeEl.textContent = meta.mimeType || 'Arquivo';
                }
            }

            // 3. Tamanho
            const sizeEl = document.getElementById('preview-size');
            if (sizeEl) {
                if (meta.mimeType === 'application/vnd.google-apps.folder' || type === 'folder') {
                    if (meta.hasCalculatedSize) {
                        sizeEl.textContent = humanSize(meta.estimatedSize) + ' (estimado)';
                    } else {
                        sizeEl.textContent = '‚Äî';
                    }
                } else {
                    if (meta.size !== undefined && meta.size !== null) {
                        sizeEl.textContent = humanSize(parseInt(meta.size));
                    } else {
                        sizeEl.textContent = 'Indispon√≠vel';
                    }
                }
            }

            // 4. Data
            const modEl = document.getElementById('preview-modified');
            if (modEl) {
                if (meta.modifiedTime) {
                    try {
                        modEl.textContent = new Date(meta.modifiedTime).toLocaleString('pt-BR');
                    } catch (e) { modEl.textContent = meta.modifiedTime; }
                } else {
                    modEl.textContent = '-';
                }
            }

            // 5. Link
            const link = document.getElementById('preview-open-link');
            if (link) {
                if (meta.webViewLink) {
                    link.href = meta.webViewLink;
                    link.classList.remove('disabled');
                    link.style.pointerEvents = 'auto';
                } else {
                    link.classList.add('disabled');
                    link.removeAttribute('href');
                }
            }

            // 6. Thumbnail (CORRIGIDO)
            const thumbWrapper = document.getElementById('preview-thumbnail-wrapper');
            const img = document.getElementById('preview-thumbnail');

            if (thumbWrapper && img) {
                if (meta.thumbnailLink) {
                    // Define comportamento de erro ANTES de carregar
                    img.onerror = function () {
                        // Se falhar ao carregar a vers√£o grande (s600), tenta a original
                        if (this.src.includes('=s600')) {
                            console.warn("Falha ao carregar thumbnail HD, tentando original...");
                            this.src = meta.thumbnailLink;
                        } else {
                            // Se falhar a original tamb√©m, esconde tudo
                            thumbWrapper.classList.add('hidden');
                        }
                    };

                    img.onload = function () {
                        thumbWrapper.classList.remove('hidden');
                    };

                    // Usa Regex para substituir qualquer tamanho (=s220, =s100, etc) por =s600
                    // Se n√£o tiver parametro de tamanho, apenas adiciona.
                    let hdLink = meta.thumbnailLink;
                    if (hdLink.match(/=s\d+/)) {
                        hdLink = hdLink.replace(/=s\d+/, '=s600');
                    } else {
                        hdLink += '=s600';
                    }

                    img.src = hdLink;
                    thumbWrapper.classList.remove('hidden'); // Mostra container preventivamente
                } else {
                    thumbWrapper.classList.add('hidden');
                }
            }
        }

        // =========================================================
        // INICIALIZA√á√ÉO DA √ÅRVORE (ROOT)
        // =========================================================

        function initTree() {
            const ul = document.getElementById('tree-root');
            ul.innerHTML = '';

            const rootLi = document.createElement('li');
            rootLi.className = 'tree-node';
            rootLi.dataset.id = 'root';
            rootLi.dataset.name = 'Meu Drive';
            rootLi.dataset.type = 'folder';

            const row = document.createElement('div');
            row.className = 'tree-row';

            const toggle = document.createElement('button');
            toggle.className = 'tree-toggle';
            toggle.textContent = '‚ñæ';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'select-checkbox';

            const fav = document.createElement('button');
            fav.className = 'fav-btn';
            fav.textContent = '‚òÜ';

            const icon = document.createElement('span');
            icon.className = 'tree-folder-icon';
            icon.textContent = 'üìÅ';

            const span = document.createElement('span');
            span.className = 'tree-name';
            span.textContent = 'Meu Drive';

            row.append(toggle, cb, fav, icon, span);
            const childrenUl = document.createElement('ul');
            childrenUl.className = 'tree-children';

            rootLi.append(row, childrenUl);
            ul.appendChild(rootLi);

            // Item reference
            const item = { id: 'root', name: 'Meu Drive', type: 'folder' };

            // Inicializa Cache do Root
            itemCache.set('root', {
                id: 'root',
                name: 'Meu Drive',
                mimeType: 'application/vnd.google-apps.folder',
                webViewLink: 'https://drive.google.com'
            });

            if (isFavorite('root')) fav.classList.add('fav-on');

            fav.onclick = (e) => { e.stopPropagation(); toggleFavorite(item, rootLi, fav); };

            cb.onchange = (e) => {
                e.stopPropagation();
                handleCheckboxChange(cb, rootLi, item);
                propagateSelectionDown(rootLi, cb.checked);
            };

            row.onclick = (e) => {
                if (![toggle, cb, fav].includes(e.target)) {
                    showItemPreview(item, rootLi);
                }
            };

            toggle.onclick = (e) => {
                e.stopPropagation();
                const isC = rootLi.classList.contains('collapsed');
                if (isC && !rootLi.dataset.loaded) loadChildren('root', childrenUl, rootLi, toggle);
                setCollapsedState(rootLi, !isC);
                toggle.textContent = rootLi.classList.contains('collapsed') ? '‚ñ∏' : '‚ñæ';
            };

            loadChildren('root', childrenUl, rootLi, toggle);
            setCollapsedState(rootLi, false);
        }

        function reloadTree() {
            selectedItems = [];
            selectedNodeIds = new Set();
            updateSelectionInfo();
            document.getElementById('breadcrumb-path').textContent = 'Meu Drive';
            initTree();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
            loadProfiles();
            startActiveTasksPoller();

            const tf = document.getElementById('toggle-files');
            if (tf) {
                tf.addEventListener('change', () => {
                    includeFiles = tf.checked;
                    reloadTree();
                });
            }

            const om = document.getElementById('output_mode');
            if (om) om.addEventListener('change', updateOutputModeUI);

            const bd = document.getElementById('modal-backdrop');
            if (bd) {
                bd.addEventListener('click', (e) => {
                    if (e.target === bd) closeModal();
                });
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

            initTree();
        });

    </script>
</body>

</html>