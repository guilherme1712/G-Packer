<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Visualizador do Banco de Dados</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .db-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            color: #e5e7eb;
        }

        .db-section {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 600;
            color: #9ca3af;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-right: 4px;
        }

        .status-concluido {
            background: #059669;
            color: white;
        }

        .status-erro {
            background: #dc2626;
            color: white;
        }

        .status-cancelado {
            background: #d97706;
            color: white;
        }

        .status-paused {
            background: #f59e0b;
            color: black;
            border: 1px solid #d97706;
        }

        .status-iniciando,
        .status-baixando,
        .status-mapeando,
        .status-compactando {
            background: #2563eb;
            color: white;
        }

        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
            margin: 0;
            font-size: 0.75rem;
            white-space: pre-wrap;
        }
    </style>
</head>

<body class="bg-gradient">
    <div class="db-container">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>üóÑÔ∏è Dados do SQLite (gpacker.db)</h1>
            <a href="{{ url_for('drive.folders') }}" class="btn-secondary">‚Üê Voltar para Pastas</a>
        </header>

        <!-- SE√á√ÉO 1: TASKS / LOGS -->
        <div class="db-section">
            <h2 style="margin-top:0;">üìú Hist√≥rico de Tarefas (Tasks)</h2>
            <p style="color:#9ca3af; font-size:0.9rem;">Exibindo as √∫ltimas 50 tarefas.</p>

            {% if tasks %}
            <table id="tasks-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Estado</th>
                        <th>Msg</th>
                        <th>Progresso</th>
                        <th>Arquivos (F/T)</th>
                        <th>Erros</th>
                        <th>Data Atualiza√ß√£o</th>
                        <th>Logs Detalhados</th>
                    </tr>
                </thead>
                <tbody id="tasks-tbody">
                    {% for t in tasks %}
                    <tr>
                        <td style="font-family:monospace; font-size:0.8em;">{{ t.id }}</td>
                        <td>
                            {% if t.paused %}
                            <span class="status-badge status-paused">PAUSADO</span>
                            {% endif %}
                            {% if t.canceled %}
                            <span class="status-badge status-cancelado">CANCELADO</span>
                            {% endif %}
                            <span class="status-badge status-{{ t.phase }}">
                                {{ t.phase }}
                            </span>
                        </td>
                        <td>{{ t.message }}</td>
                        <td>
                            {% if t.files_total > 0 %}
                            {{ ((t.files_downloaded / t.files_total) * 100) | int }}%
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ t.files_downloaded }} / {{ t.files_total }}</td>
                        <td style="{{ 'color:#ef4444; font-weight:bold;' if t.errors_count > 0 else '' }}">
                            {{ t.errors_count }}
                        </td>
                        <td>{{ t.updated_at.strftime('%d/%m %H:%M:%S') if t.updated_at else '-' }}</td>
                        <td style="width:350px;">
                            {% if t.history %}
                            <pre>{{ t.history | join('\n') }}</pre>
                            {% else %}
                            <span style="color:#666">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhuma tarefa encontrada.</p>
            {% endif %}
        </div>

        <!-- SE√á√ÉO 2: PERFIS -->
        <div class="db-section">
            <h2 style="margin-top:0;">‚öôÔ∏è Perfis de Backup Salvos</h2>
            {% if profiles %}
            <table id="profiles-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Padr√£o ZIP</th>
                        <th>Execu√ß√£o</th>
                        <th>Filtros</th>
                        <th>Modo</th>
                    </tr>
                </thead>
                <tbody id="profiles-tbody">
                    {% for p in profiles %}
                    <tr>
                        <td>{{ p.id }}</td>
                        <td><strong>{{ p.name }}</strong></td>
                        <td>{{ p.zip_name or p.zip_pattern }}</td>
                        <td>
                            <span class="status-badge" style="background:#4b5563;">{{ p.execution_mode }}</span>
                        </td>
                        <td>{{ p.groups }}</td>
                        <td>{{ p.output_mode }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum perfil salvo.</p>
            {% endif %}
        </div>

        <!-- SE√á√ÉO 3: AGENDAMENTOS -->
        <div class="db-section">
            <h2 style="margin-top:0;">‚è±Ô∏è Agendamentos (Scheduler)</h2>
            <p style="color:#9ca3af; font-size:0.9rem;">
                Lista de todos os agendamentos, mostrando os pendentes (ainda v√£o rodar)
                e os que j√° foram executados pelo menos uma vez.
            </p>

            {% if sched_tasks %}
            <table id="sched-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Situa√ß√£o</th>
                        <th>Frequ√™ncia</th>
                        <th>Hor√°rio</th>
                        <th>Pr√≥xima Execu√ß√£o</th>
                        <th>√öltima Execu√ß√£o</th>
                        <th>Status da √öltima Exec.</th>
                        <th>Itens</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="sched-tbody">
                    {% for s in sched_tasks %}
                    <tr>
                        <td style="font-family:monospace; font-size:0.8em;">{{ s.id }}</td>
                        <td><strong>{{ s.name }}</strong></td>

                        <!-- Situa√ß√£o: pendente / j√° executado / desativado -->
                        <td data-col="situacao">
                            {% if s.active %}
                                {% if s.last_run_at %}
                                    <span class="status-badge status-concluido">
                                        ATIVO ¬∑ J√Å EXECUTOU
                                    </span>
                                {% else %}
                                    <span class="status-badge status-iniciando">
                                        PENDENTE
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="status-badge status-cancelado">
                                    DESATIVADO
                                </span>
                            {% endif %}
                        </td>

                        <td>{{ s.frequency|upper }}</td>
                        <td>{{ s.run_time }}</td>
                        <td>
                            {% if s.next_run_at %}
                            {{ s.next_run_at.strftime('%d/%m/%Y %H:%M') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if s.last_run_at %}
                            {{ s.last_run_at.strftime('%d/%m/%Y %H:%M') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td style="max-width:260px;">
                            {% if s.last_status %}
                            <pre>{{ s.last_status }}</pre>
                            {% else %}
                            <span style="color:#666">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ s.items_count }}
                        </td>

                        <td>
                            <!-- Alternar ativo/desativado -->
                            <button type="button" class="btn-ghost btn-xs" onclick="toggleSchedule({{ s.id }}, this)">
                                {% if s.active %}Desativar{% else %}Ativar{% endif %}
                            </button>

                            <!-- Excluir agendamento -->
                            <button type="button" class="btn-danger btn-xs" onclick="deleteSchedule({{ s.id }}, this)">
                                Excluir
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum agendamento encontrado.</p>
            {% endif %}
        </div>
    </div>

    <script>
        // ===========================
        // POLLING DAS TASKS (1s)
        // ===========================
        function renderTasksTable(tasks) {
            const tbody = document.getElementById('tasks-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            tasks.forEach(t => {
                const tr = document.createElement('tr');

                const pct = t.files_total > 0
                    ? Math.floor((t.files_downloaded / t.files_total) * 100) + '%'
                    : '-';

                // monta badges de estado
                let estadoHtml = '';
                if (t.paused) {
                    estadoHtml += '<span class="status-badge status-paused">PAUSADO</span>';
                }
                if (t.canceled) {
                    estadoHtml += '<span class="status-badge status-cancelado">CANCELADO</span>';
                }
                estadoHtml += `<span class="status-badge status-${t.phase}">${t.phase}</span>`;

                // history
                let historyHtml = '<span style="color:#666">-</span>';
                if (Array.isArray(t.history) && t.history.length > 0) {
                    historyHtml = `<pre>${t.history.join('\n')}</pre>`;
                } else if (typeof t.history === 'string' && t.history.trim() !== '') {
                    historyHtml = `<pre>${t.history}</pre>`;
                }

                const errorsStyle = t.errors_count > 0
                    ? 'color:#ef4444; font-weight:bold;'
                    : '';

                tr.innerHTML = `
                    <td style="font-family:monospace; font-size:0.8em;">${t.id}</td>
                    <td>${estadoHtml}</td>
                    <td>${t.message || ''}</td>
                    <td>${pct}</td>
                    <td>${t.files_downloaded} / ${t.files_total}</td>
                    <td style="${errorsStyle}">${t.errors_count}</td>
                    <td>${t.updated_at || '-'}</td>
                    <td style="width:350px;">${historyHtml}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        function pollTasks() {
            fetch('/admin/api/tasks')
                .then(r => r.json())
                .then(data => {
                    if (!Array.isArray(data)) return;
                    renderTasksTable(data);
                })
                .catch(err => {
                    console.error('Erro ao buscar tasks:', err);
                });
        }

        // inicia polling a cada 1 segundo
        setInterval(pollTasks, 700);
        // chama uma vez ao carregar
        pollTasks();

        // ===========================
        // A√á√ïES EM AGENDAMENTOS
        // ===========================
        function toggleSchedule(id, btn) {
            if (!id) return;

            btn.disabled = true;

            fetch(`/scheduler/toggle/${id}`, {
                method: 'POST'
            })
                .then(r => r.json())
                .then(data => {
                    if (!data.ok) {
                        alert(data.error || 'Erro ao alterar agendamento.');
                        return;
                    }

                    const row = btn.closest('tr');
                    if (!row) return;

                    const situacaoCell = row.querySelector('[data-col="situacao"]');
                    if (!situacaoCell) return;

                    // Limpa conte√∫do atual
                    situacaoCell.innerHTML = '';

                    if (data.active) {
                        // Ativou
                        const span = document.createElement('span');
                        span.className = 'status-badge status-iniciando';
                        span.textContent = 'PENDENTE';
                        situacaoCell.appendChild(span);
                        btn.textContent = 'Desativar';
                    } else {
                        // Desativou
                        const span = document.createElement('span');
                        span.className = 'status-badge status-cancelado';
                        span.textContent = 'DESATIVADO';
                        situacaoCell.appendChild(span);
                        btn.textContent = 'Ativar';
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Erro de comunica√ß√£o com o servidor.');
                })
                .finally(() => {
                    btn.disabled = false;
                });
        }

        function deleteSchedule(id, btn) {
            if (!id) return;

            if (!confirm('Tem certeza que deseja excluir este agendamento?')) {
                return;
            }

            btn.disabled = true;

            fetch(`/scheduler/delete/${id}`, {
                method: 'POST'
            })
                .then(r => r.json())
                .then(data => {
                    if (!data.ok) {
                        alert(data.error || 'Erro ao excluir agendamento.');
                        return;
                    }

                    const row = btn.closest('tr');
                    if (row) {
                        row.remove();
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Erro de comunica√ß√£o com o servidor.');
                })
                .finally(() => {
                    btn.disabled = false;
                });
        }
    </script>

</body>

</html>
