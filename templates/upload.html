{% extends "layout.html" %}

{% block title %}Central de Upload{% endblock %}

{% block extra_head %}
<style>
    /* =========================================
       LAYOUT GRID PRINCIPAL
       ========================================= */
    h2 {
        color: white;
    }

    .page-content-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        overflow: hidden;
        padding: 0 24px 24px 24px;
    }

    .upload-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        grid-template-rows: auto 1fr;
        gap: 20px;
        height: 100%;
        min-height: 0;
    }

    @media (max-width: 992px) {
        .page-content-wrapper {
            height: auto;
            overflow: auto;
        }

        .upload-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 600px;
            height: auto;
        }
    }

    /* =========================================
       STATUS BAR (PROGRESSO GLOBAL)
       ========================================= */
    .status-bar-container {
        grid-column: 1 / -1;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 12px;
        padding: 12px 20px;
        display: none;
        /* Oculto se vazio */
        align-items: center;
        gap: 20px;
        backdrop-filter: blur(10px);
        animation: slideDown 0.3s ease;
    }

    .status-bar-container.active {
        display: flex;
    }

    .status-info {
        flex: 1;
    }

    .status-metrics {
        display: flex;
        gap: 15px;
        font-size: 0.8rem;
        color: #cbd5e1;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        padding-left: 15px;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-10px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* =========================================
       GLASS PANELS & UI
       ========================================= */
    .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(12px);
    }

    .panel-header {
        padding: 16px 20px;
        background: rgba(15, 23, 42, 0.4);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-title {
        color: #f1f5f9;
        font-weight: 600;
        font-size: 1rem;
        margin: 0;
    }

    /* SWITCH CUSTOMIZADO */
    .structure-toggle {
        background: rgba(0, 0, 0, 0.3);
        padding: 12px;
        border-radius: 8px;
        margin: 16px 16px 0 16px;
        border: 1px solid rgba(99, 102, 241, 0.2);
        display: flex;
        align-items: center;
    }

    /* DROPZONE & LISTA */
    .left-column {
        display: flex;
        flex-direction: column;
        gap: 16px;
        height: 100%;
        min-height: 0;
    }

    .dropzone-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .dropzone-area {
        flex: 1;
        margin: 16px;
        border: 2px dashed rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        background: rgba(99, 102, 241, 0.02);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        min-height: 150px;
    }

    .dropzone-area.drag-over {
        border-color: #818cf8;
        background: rgba(99, 102, 241, 0.1);
    }

    .drop-icon {
        width: 64px;
        height: 64px;
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin-bottom: 16px;
    }

    .file-queue-container {
        height: 50%;
        display: none;
        flex-direction: column;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(15, 23, 42, 0.3);
    }

    .file-queue-container.active {
        display: flex;
    }

    .queue-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .queue-scroll::-webkit-scrollbar {
        width: 5px;
    }

    .queue-scroll::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
    }

    .file-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.03);
        margin-bottom: 6px;
        border-radius: 6px;
        font-size: 0.85rem;
        color: #cbd5e1;
    }

    /* TREEVIEW & ACTIONS */
    .right-column {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
    }

    .tree-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        min-height: 0;
    }

    .action-footer {
        padding: 20px;
        background: rgba(15, 23, 42, 0.5);
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .target-box {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-hero {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-hero:disabled {
        background: #334155;
        color: #64748b;
        cursor: not-allowed;
        box-shadow: none;
    }

    /* TREE CSS */
    .tree-root,
    .tree-children {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    .tree-children {
        padding-left: 0;
        margin-left: 18px;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
    }

    .tree-row {
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
        color: #94a3b8;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tree-row:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
    }

    .tree-row.selected {
        background: rgba(99, 102, 241, 0.2);
        color: #fff;
        font-weight: 600;
    }

    .tree-toggle {
        width: 20px;
        text-align: center;
        color: #64748b;
        font-weight: bold;
    }

    /* BARRA DE PROGRESSO NEON */
    .progress-container {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 20px;
        height: 24px;
        width: 100%;
        margin-top: 12px;
        margin-bottom: 12px;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899);
        width: 0%;
        border-radius: 20px;
        box-shadow: 0 0 15px rgba(168, 85, 247, 0.8);
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .progress-bar-animated {
        background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);
        background-size: 2rem 2rem;
        animation: progress-bar-stripes 1.5s linear infinite;
    }

    @keyframes progress-bar-stripes {
        0% {
            background-position: 2rem 0;
        }

        100% {
            background-position: 0 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-content-wrapper">
    <div class="d-flex justify-content-between align-items-end mb-3 px-1">
        <div>
            <h2 class="h4 text-white fw-bold mb-0">Central de Upload</h2>
            <small class="text-secondary">Gerencie transferências para o Google Drive</small>
        </div>
    </div>

    <div class="upload-grid">
        <div id="globalProgressPanel" class="status-bar-container">
            <div
                style="width: 40px; height: 40px; border-radius: 50%; background: rgba(99,102,241,0.2); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-sync fa-spin text-primary"></i>
            </div>
            <div class="status-info" style="width: 100%;">
                <div class="d-flex justify-content-between align-items-end">
                    <span class="status-title" id="globalStatusText">Sincronizando...</span>
                    <span class="fw-bold" id="globalPercent" style="color: white;">0%</span>
                </div>
                <div class="progress-container">
                    <div id="globalProgressBar" class="progress-bar-fill progress-bar-animated"></div>
                </div>
            </div>
            <div class="status-metrics">
                <div class="text-center"><strong class="d-block text-white" id="countTotal">0</strong><span>Total</span>
                </div>
                <div class="text-center"><strong class="d-block text-success"
                        id="countSuccess">0</strong><span>Ok</span></div>
                <div class="text-center"><strong class="d-block text-danger" id="countError">0</strong><span>Erro</span>
                </div>
            </div>
        </div>

        <div class="glass-panel left-column">
            <div class="panel-header">
                <h3 class="panel-title"><i class="fas fa-cloud-upload-alt text-primary"></i> Origem</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary"
                        onclick="document.getElementById('fileInput').click()">+ Arq</button>
                    <button class="btn btn-sm btn-outline-secondary"
                        onclick="document.getElementById('folderInput').click()">+ Pasta</button>
                </div>
            </div>

            <div class="form-check form-switch structure-toggle">
                <input class="form-check-input" type="checkbox" id="chkPreserveStructure" checked
                    style="cursor: pointer;">
                <label class="form-check-label text-white ps-2" for="chkPreserveStructure" style="cursor: pointer;">
                    <strong>Manter estrutura de pastas</strong>
                    <div class="text-secondary small">Se desligado, arquivos soltos irão para a raiz selecionada.</div>
                </label>
            </div>

            <div class="dropzone-wrapper">
                <div id="dropZone" class="dropzone-area">
                    <div class="drop-icon"><i class="fas fa-arrow-up"></i></div>
                    <h5 class="text-white mb-1">Arraste e solte aqui</h5>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
                </div>
                <div id="fileSection" class="file-queue-container">
                    <div
                        class="px-3 py-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
                        <small class="text-white fw-bold">FILA (<span id="summaryCount">0</span>)</small>
                        <button class="btn btn-xs text-danger" onclick="clearAllFiles()">Limpar</button>
                    </div>
                    <div id="fileList" class="queue-scroll"></div>
                </div>
            </div>
        </div>

        <div class="glass-panel right-column">
            <div class="panel-header">
                <h3 class="panel-title"><i class="fas fa-folder-tree text-warning"></i> Destino</h3>
            </div>
            <div id="treeWrapper" class="tree-wrapper">
                <ul id="tree-root" class="tree-root"></ul>
            </div>
            <input type="hidden" id="targetFolderId" value="root">
            <div class="action-footer">
                <div class="target-box">
                    <i class="fab fa-google-drive fa-lg text-success"></i>
                    <div style="overflow: hidden;">
                        <span class="d-block text-secondary" style="font-size: 0.7rem; font-weight: 700;">SALVAR
                            EM:</span>
                        <strong class="text-white text-truncate d-block" id="selectedFolderNameDisplay">Meu Drive
                            (Raiz)</strong>
                    </div>
                </div>
                <button id="btnUpload" class="btn-hero" disabled>
                    <i class="fas fa-paper-plane me-2"></i> INICIAR UPLOAD
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ESTADO GLOBAL ---
    let uploadQueue = [];

    // --- INICIALIZAÇÃO ---
    document.addEventListener("DOMContentLoaded", () => {
        initTree();
        startGlobalMonitor();

        // RE-BINDING EVENT LISTENERS (CRÍTICO PARA FUNCIONAR)
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');

        if (fileInput) fileInput.addEventListener('change', e => addFiles(Array.from(e.target.files)));
        if (folderInput) folderInput.addEventListener('change', e => addFiles(Array.from(e.target.files), true));

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('drag-over'); }));
        ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('drag-over'); }));

        dropZone.addEventListener('drop', async e => {
            e.preventDefault(); dropZone.classList.remove('drag-over');
            const items = e.dataTransfer.items;
            if (!items) return;

            // Visual feedback
            dropZone.style.opacity = '0.5';
            const promises = [];
            for (let i = 0; i < items.length; i++) {
                const entry = items[i].webkitGetAsEntry();
                if (entry) promises.push(traverse(entry));
            }
            await Promise.all(promises);
            dropZone.style.opacity = '1';
            updateUI();
        });
    });

    // --- MANIPULAÇÃO DE ARQUIVOS ---
    async function traverse(entry, path = '') {
        if (entry.isFile) {
            return new Promise(resolve => entry.file(f => {
                addFile(f, path + f.name);
                resolve();
            }));
        }
        if (entry.isDirectory) {
            const reader = entry.createReader();
            return new Promise(resolve => {
                const readEntries = () => {
                    reader.readEntries(async entries => {
                        if (!entries.length) resolve();
                        else {
                            await Promise.all(entries.map(e => traverse(e, path + entry.name + '/')));
                            readEntries(); // Continua lendo (chunks)
                        }
                    });
                };
                readEntries();
            });
        }
    }

    function addFiles(files, isDir = false) {
        files.forEach(f => {
            // Se veio de input folder, usa webkitRelativePath, senão usa name
            const path = (isDir && f.webkitRelativePath) ? f.webkitRelativePath : f.name;
            addFile(f, path);
        });
        updateUI();
    }

    function addFile(f, path) {
        // Evita duplicatas exatas na fila
        if (!uploadQueue.some(i => i.path === path)) {
            uploadQueue.push({ file: f, path: path });
        }
    }

    function clearAllFiles() {
        uploadQueue = [];
        updateUI();
    }

    function updateUI() {
        const hasFiles = uploadQueue.length > 0;
        const fileSection = document.getElementById('fileSection');
        const dropZone = document.getElementById('dropZone');

        fileSection.classList.toggle('active', hasFiles);

        // Ajuste visual
        dropZone.style.flex = hasFiles ? '0 0 auto' : '1';
        dropZone.style.height = hasFiles ? '160px' : 'auto';

        document.getElementById('summaryCount').innerText = uploadQueue.length;
        document.getElementById('btnUpload').disabled = !hasFiles;

        // Renderiza lista (Limitada a 100 para não travar)
        const listHtml = uploadQueue.slice(0, 100).map((i, idx) => `
            <div class="file-row">
                <i class="fas ${i.path.includes('/') ? 'fa-folder text-warning' : 'fa-file text-info'}"></i>
                <div class="text-truncate flex-grow-1">${i.path}</div>
                <span class="text-muted ms-2">${formatSize(i.file.size)}</span>
                <i class="fas fa-times text-danger ms-2" style="cursor:pointer" onclick="removeFromQueue(${idx})"></i>
            </div>
        `).join('');

        const extraCount = uploadQueue.length - 100;
        document.getElementById('fileList').innerHTML = listHtml + (extraCount > 0 ? `<div class="text-center small text-muted p-2">+ ${extraCount} outros arquivos...</div>` : '');
    }

    function removeFromQueue(idx) {
        uploadQueue.splice(idx, 1);
        updateUI();
    }

    function formatSize(b) {
        if (b === 0) return '0 B';
        const i = Math.floor(Math.log(b) / Math.log(1024));
        return (b / Math.pow(1024, i)).toFixed(2) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
    }

    // --- UPLOAD E MONITORAMENTO ---
    document.getElementById('btnUpload').onclick = async () => {
        const btn = document.getElementById('btnUpload');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO PARA SERVIDOR...';

        const targetFolderId = document.getElementById('targetFolderId').value;
        const preserveStructure = document.getElementById('chkPreserveStructure').checked;

        // Paralelismo no Frontend
        const CONCURRENCY_LIMIT = 2;
        const queueToProcess = [...uploadQueue];
        const totalItems = queueToProcess.length;
        let processedCount = 0;

        const processItem = async (item) => {
            const fd = new FormData();
            fd.append('file', item.file);
            fd.append('relative_path', item.path);
            fd.append('target_root_id', targetFolderId);
            fd.append('preserve_structure', preserveStructure); // Envia o checkbox

            try {
                await fetch('/api/upload/enqueue', { method: 'POST', body: fd });
            } catch (e) {
                console.error("Erro rede:", e);
            } finally {
                processedCount++;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ENFILEIRANDO (${processedCount}/${totalItems})`;
            }
        };

        // Workers
        const worker = async () => {
            while (queueToProcess.length > 0) {
                const item = queueToProcess.shift();
                if (item) await processItem(item);
            }
        };

        const workers = [];
        for (let i = 0; i < Math.min(CONCURRENCY_LIMIT, totalItems); i++) {
            workers.push(worker());
        }
        await Promise.all(workers);

        btn.innerHTML = '<i class="fas fa-check"></i> FEITO!';
        clearAllFiles();
        setTimeout(() => {
            btn.innerHTML = 'INICIAR UPLOAD';
            btn.disabled = false;
        }, 2000);
    };

    // Polling do Banco de Dados
    let monitorInterval = null;
    function startGlobalMonitor() {
        if (monitorInterval) clearInterval(monitorInterval);
        monitorInterval = setInterval(async () => {
            try {
                const res = await fetch('/api/upload/global-status');
                const stats = await res.json();
                updateMonitorUI(stats);
            } catch (e) { }
        }, 2000);
    }

    function updateMonitorUI(stats) {
        const panel = document.getElementById('globalProgressPanel');
        const bar = document.getElementById('globalProgressBar');

        const total = stats.total_files;
        const processed = stats.success + stats.error;

        if (total === 0) {
            panel.classList.remove('active');
            return;
        }

        // Mantém painel visível se tem pendência ou acabou recentemente
        panel.classList.add('active');

        const percent = total > 0 ? Math.round((processed / total) * 100) : 0;

        bar.style.width = percent + '%';
        document.getElementById('globalPercent').innerText = percent + '%';
        document.getElementById('countTotal').innerText = total;
        document.getElementById('countSuccess').innerText = stats.success;
        document.getElementById('countError').innerText = stats.error;

        if (stats.pending > 0) {
            document.getElementById('globalStatusText').innerHTML = `<i class="fas fa-satellite-dish me-2 animate-pulse"></i> Processando ${stats.pending} arquivos...`;
            bar.classList.add('progress-bar-animated');
            bar.style.background = 'linear-gradient(90deg, #6366f1, #a855f7, #ec4899)';
        } else {
            document.getElementById('globalStatusText').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i> Concluído!`;
            bar.classList.remove('progress-bar-animated');
            bar.style.background = '#22c55e';
        }
    }

    // --- ÁRVORE DE PASTAS ---
    function initTree() {
        const ul = document.getElementById('tree-root');
        ul.innerHTML = '';
        const rootLi = createFolderNode({ id: 'root', name: 'Meu Drive' });
        ul.appendChild(rootLi);
        toggleNode(rootLi, 'root', rootLi.querySelector('.tree-toggle'));
    }

    function createFolderNode(folder) {
        const li = document.createElement('li'); li.className = 'tree-node collapsed'; li.dataset.id = folder.id;
        const row = document.createElement('div'); row.className = 'tree-row';
        row.onclick = (e) => { if (!e.target.classList.contains('tree-toggle')) selectFolder(folder.id, folder.name, row); };

        const toggle = document.createElement('span'); toggle.className = 'tree-toggle'; toggle.innerText = '▸';
        toggle.onclick = (e) => { e.stopPropagation(); toggleNode(li, folder.id, toggle); };

        row.append(toggle, Object.assign(document.createElement('i'), { className: 'fas fa-folder text-warning' }), document.createTextNode(folder.name));
        li.append(row, Object.assign(document.createElement('ul'), { className: 'tree-children' }));
        return li;
    }

    async function toggleNode(li, id, toggle) {
        const ul = li.querySelector('.tree-children');
        if (li.classList.contains('collapsed')) {
            li.classList.remove('collapsed'); ul.style.display = 'block'; toggle.innerText = '▾';
            if (!li.dataset.loaded) {
                try {
                    const res = await fetch(`/api/drive/tree-nodes?parent_id=${encodeURIComponent(id)}`);
                    const data = await res.json();
                    if (data.ok) {
                        ul.innerHTML = '';
                        data.items.forEach(i => { if (i.type === 'folder') ul.appendChild(createFolderNode(i)); });
                        li.dataset.loaded = 'true';
                    }
                } catch { }
            }
        } else {
            li.classList.add('collapsed'); ul.style.display = 'none'; toggle.innerText = '▸';
        }
    }

    function selectFolder(id, name, row) {
        document.querySelectorAll('.tree-row.selected').forEach(e => e.classList.remove('selected'));
        row.classList.add('selected');
        document.getElementById('targetFolderId').value = id;
        document.getElementById('selectedFolderNameDisplay').innerText = name;
    }
</script>
{% endblock %}